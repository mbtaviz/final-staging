!function(a,b){"function"==typeof define&&define.amd?define(["d3"],b):a.d3.tip=b(a.d3)}(this,function(a){return function(){function b(a){u=o(a),v=u.createSVGPoint(),document.body.appendChild(t)}function c(){return"n"}function d(){return[0,0]}function e(){return" "}function f(){var a=p();return{top:a.n.y-t.offsetHeight,left:a.n.x-t.offsetWidth/2}}function g(){var a=p();return{top:a.s.y,left:a.s.x-t.offsetWidth/2}}function h(){var a=p();return{top:a.e.y-t.offsetHeight/2,left:a.e.x}}function i(){var a=p();return{top:a.w.y-t.offsetHeight/2,left:a.w.x-t.offsetWidth}}function j(){var a=p();return{top:a.nw.y-t.offsetHeight,left:a.nw.x-t.offsetWidth}}function k(){var a=p();return{top:a.ne.y-t.offsetHeight,left:a.ne.x}}function l(){var a=p();return{top:a.sw.y,left:a.sw.x-t.offsetWidth}}function m(){var a=p();return{top:a.se.y,left:a.e.x}}function n(){var b=a.select(document.createElement("div"));return b.style({position:"absolute",top:0,opacity:0,"pointer-events":"none","box-sizing":"border-box"}),b.node()}function o(a){return a=a.node(),"svg"==a.tagName.toLowerCase()?a:a.ownerSVGElement}function p(){var b=w||a.event.target,c={},d=b.getScreenCTM(),e=b.getBBox(),f=e.width,g=e.height,h=e.x,i=e.y;return v.x=h,v.y=i,c.nw=v.matrixTransform(d),v.x+=f,c.ne=v.matrixTransform(d),v.y+=g,c.se=v.matrixTransform(d),v.x-=f,c.sw=v.matrixTransform(d),v.y-=g/2,c.w=v.matrixTransform(d),v.x+=f,c.e=v.matrixTransform(d),v.x-=f/2,v.y-=g/2,c.n=v.matrixTransform(d),v.y+=g,c.s=v.matrixTransform(d),c}var q=c,r=d,s=e,t=n(),u=null,v=null,w=null;b.show=function(){var c=Array.prototype.slice.call(arguments);c[c.length-1]instanceof SVGElement&&(w=c.pop());var d,e=s.apply(this,c),f=r.apply(this,c),g=q.apply(this,c),h=a.select(t),i=y.length,j=document.documentElement.scrollTop||document.body.scrollTop,k=document.documentElement.scrollLeft||document.body.scrollLeft;for(h.html(e).style({opacity:1,"pointer-events":"all"});i--;)h.classed(y[i],!1);return d=x.get(g).apply(this),h.classed(g,!0).style({top:d.top+f[0]+j+"px",left:d.left+f[1]+k+"px"}),b},b.hide=function(){return nodel=a.select(t),nodel.style({opacity:0,"pointer-events":"none"}),b},b.attr=function(c){if(arguments.length<2&&"string"==typeof c)return a.select(t).attr(c);var d=Array.prototype.slice.call(arguments);return a.selection.prototype.attr.apply(a.select(t),d),b},b.style=function(c){if(arguments.length<2&&"string"==typeof c)return a.select(t).style(c);var d=Array.prototype.slice.call(arguments);return a.selection.prototype.style.apply(a.select(t),d),b},b.direction=function(c){return arguments.length?(q=null==c?c:a.functor(c),b):q},b.offset=function(c){return arguments.length?(r=null==c?c:a.functor(c),b):r},b.html=function(c){return arguments.length?(s=null==c?c:a.functor(c),b):s};var x=a.map({n:f,s:g,e:h,w:i,nw:j,ne:k,sw:l,se:m}),y=x.keys();return b}}),function(){function a(a){return a[0]}function b(a){return a[1]}function c(a,b,c){return"offset"==c?function(c){return"translate(0,"+(c+(0>c)-a)*b+")"}:function(c){return(0>c?"scale(1,-1)":"")+"translate(0,"+(c-a)*b+")"}}d3.horizon=function(){function f(a){a.each(function(a){var b,f,q,r,s=d3.select(this),t=1/0,u=-1/0,v=a.map(function(a,b){var c=j.call(this,a,b),d=k.call(this,a,b);return t>c&&(t=c),c>u&&(u=c),-d>l&&(l=-d),d>l&&(l=d),[c,d]}),w=d3.scale.linear().domain([t,u]).range([0,m]),x=d3.scale.linear().domain([0,l]).range([0,n*g]),y=c(g,n,h);this.__chart__?(b=this.__chart__.x,f=this.__chart__.y,q=this.__chart__.t,r=this.__chart__.id):(b=w.copy(),f=x.copy(),q=y,r=++e);var z=s.selectAll("defs").data([null]);z.enter().append("defs").append("clipPath").attr("id","d3_horizon_clip"+r).append("rect").attr("width",m).attr("height",n),z.select("rect").transition().duration(o).attr("width",m).attr("height",n),s.selectAll("g").data([null]).enter().append("g").attr("clip-path","url(#d3_horizon_clip"+r+")");var A=s.select("g").selectAll("path").data(d3.range(-1,-g-1,-1).concat(d3.range(1,g+1)),Number),B=d.interpolate(i).x(function(a){return b(a[0])}).y0(n*g).y1(function(a){return n*g-f(a[1])})(v),C=d.x(function(a){return w(a[0])}).y1(function(a){return n*g-x(a[1])})(v);A.enter().append("path").style("fill",p).attr("transform",q).attr("d",B),A.transition().duration(o).style("fill",p).attr("transform",y).attr("d",C),A.exit().transition().duration(o).attr("transform",y).attr("d",C).remove(),this.__chart__={x:w,y:x,t:y,id:r}}),d3.timer.flush()}var g=1,h="offset",i="linear",j=a,k=b,l=-1/0,m=960,n=40,o=0,p=d3.scale.linear().domain([-1,0,1]).range(["#d62728","#fff","#1f77b4"]);return f.duration=function(a){return arguments.length?(o=+a,f):o},f.bands=function(a){return arguments.length?(g=+a,p.domain([-g,0,g]),f):g},f.color=p,f.mode=function(a){return arguments.length?(h=a+"",f):h},f.colors=function(a){return arguments.length?(p.range(a),f):p.range()},f.interpolate=function(a){return arguments.length?(i=a+"",f):i},f.x=function(a){return arguments.length?(j=a,f):j},f.y=function(a){return arguments.length?(k=a,f):k},f.yMax=function(a){return arguments.length?(l=a,f):l},f.width=function(a){return arguments.length?(m=+a,f):m},f.height=function(a){return arguments.length?(n=+a,f):n},f};var d=d3.svg.area(),e=0}(),function(){"use strict";function a(a){h.push(a),a(f(),g())}function b(){var a=f(),b=g();h.forEach(function(c){c(Math.max(600,a),b)})}function c(a,b){a.each(function(){for(var a,c=d3.select(this),d=c.text().split(/\s+/).reverse(),e=[],f=0,g=1.1,h=c.attr("y")||0,i=c.attr("x")||0,j=parseFloat(c.attr("dy")||0),k=c.text(null).append("tspan").attr("x",i).attr("y",h).attr("dy",j+"em");a=d.pop();)e.push(a),k.text(e.join(" ")),(k.node().getComputedTextLength()>b||"<br>"===a)&&(e.pop(),k.text(e.join(" ")),e="<br>"!==a?[a]:[],k=c.append("tspan").attr("x",i).attr("y",h).attr("dy",++f*g+j+"em").text(a))})}function d(a,b){var c=d3.select("body").appendOnce("svg","svgdefs").attr("width",0).attr("height",0).appendOnce("defs","defs").appendOnce("linearGradient",b).firstTime.attr("id",b).attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("spreadMethod","pad"),d=d3.scale.linear().domain(d3.extent(a.domain())).range(["0%","100%"]);c.selectAll("stop").data(a.domain()).enter().append("svg:stop").attr("offset",d).attr("stop-color",a).attr("stop-opacity",1)}var e=/iPad|iPod|iPhone/.test(navigator.userAgent);d3.select("html").classed("ios",e);var f=e?function(){return document.body.clientWidth}:function(){return window.innerWidth||document.documentElement.clientWidth},g=e?function(){var a,b;switch(window.orientation||0){case 90:case-90:a=screen.height,b=screen.availWidth;break;default:a=screen.width,b=screen.availHeight}return b/a*document.body.clientWidth}:function(){return window.innerHeight||document.documentElement.clientHeight},h=[];d3.select(window).on("resize.watch",b).on("load.watch",b).on("orientationchange.watch",b).call(b),d3.select(window).on("scroll.d3-tip-hide",function(){d3.selectAll(".d3-tip").style("top","-50px")}),d3.selection.prototype.appendOnce=function(a,b){var c=this.selectAll("."+b.replace(/ /g,".")).data([1]);return c.firstTime=c.enter().append(a).attr("class",b),c},d3.selection.prototype.onOnce=function(a,b,c){return this.each(function(){$(this).on(a,b,function(a){var b=d3.select(this).datum();try{return d3.event=a.originalEvent,c.call(this,b)}finally{d3.event=null}})}),this},d3.selection.prototype.off=function(a){var b=this;return a.split(/\s+/g).forEach(function(a){b.each(function(){$(b).off(a)}).on(a,null)}),b},d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},window.VIZ={ios:e,watchSize:a,wrap:c,createColorScaleGradient:d}}(),VIZ.fileSizes={"data/average-actual-delays.json":8084,"data/delay.json":2822327,"data/marey-header.json":1381,"data/marey-trips.json":818145,"data/spider.json":1928,"data/station-network.json":5389,"data/turnstile-gtfs-mapping.json":1439,"data/turnstile-heatmap.json":2542709},function(){"use strict";function a(a){var b=this;b.files=a,this.data={},b.progressListeners=[],b.doneListeners=[],b.errorListeners=[],b.amountLoaded={},a.forEach(function(a){if(a in b.amountLoaded)throw"duplicate file name "+a;b.amountLoaded[a]=0}),b.totalSize=a.reduce(function(a,b){var c=b.split("!")[1];if(!VIZ.fileSizes[c])throw"No size for "+c;return a+VIZ.fileSizes[c]},0),a.forEach(function(a){var c=a.split("!"),d=c[0],e=c[1];d3[d](e).on("progress",function(){b.fileProgress(a,d3.event.loaded)}).get(function(c,d){c?(b.errorListeners.forEach(function(a){a(c)}),b.doneListeners=[],b.progressListeners=[]):(b.fileProgress(a,VIZ.fileSizes[e]),b.fileDone(a,d))})})}a.prototype.progress=function(a){return this.progressListeners.push(a),this},a.prototype.done=function(a){return this.doneListeners.push(a),this},a.prototype.onerror=function(a){return this.errorListeners.push(a),this},a.prototype.fileProgress=function(a,b){var c=this;this.amountLoaded[a]=b,this.progressListeners.forEach(function(a){a(Math.round(100*d3.sum(d3.values(c.amountLoaded))/c.totalSize))})},a.prototype.fileDone=function(a,b){var c=this;if(this.data[a]=b,d3.keys(this.data).length===this.files.length){var d=this.files.map(function(a){return c.data[a]});this.doneListeners.forEach(function(a){a.apply(c,d)})}},VIZ.requiresData=function(b){var c=new a(b);return c}}(),function(){var a=200,b=$(".header .container"),c=$(".header .caption"),d=d3.select(".header .graphic").append("svg"),e=300,f=1e3,g=d3.scale.linear().domain([e,f]).range([e,f]).clamp(!0);VIZ.requiresData(["json!data/station-network.json","json!data/spider.json"]).done(function(e,f){"use strict";function h(a,b,c){var d=l[a.stop].pos,e=l[b.stop].pos,f=d3.interpolate(d,e)(c),g=Math.atan2(e[1]-d[1],e[0]-d[0])+Math.PI/2;return[f[0]+Math.cos(g)*n,f[1]+Math.sin(g)*n]}function i(a,b){var c=b?0:1e3/q;a||(a=r),r=a;var e=k.filter(function(b){return b.begin<a&&b.end>a}),f=e.map(function(b){for(var c=0;c<b.stops.length-1&&!(b.stops[c+1].time>a);c++);var d=b.stops[c],e=b.stops[c+1],f=(a-d.time)/(e.time-d.time);return{trip:b.trip,pos:h(d,e,f),line:b.line}}),g=d.select(".map-container").selectAll(".train").data(f,function(a){return a.trip});b?g.transition().duration(0).attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}):g.transition().duration(c).ease("linear").attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}),g.enter().append("circle").attr("class",function(a){return"train "+a.line}).attr("r",n).attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}),g.exit().remove(),a&&d.select(".time-display").text(function(){var b=moment(1e3*a);return b.format("dddd M/D h:mm a")})}function j(a,b,c){function d(a,b){q.selectAll("circle."+a).classed(b,!0).classed("end",!0).classed("middle",!1).attr("r",Math.max(p,3))}var f={top:20,right:30,bottom:10,left:10},g=d3.extent(e.nodes,function(a){return a.x}),h=d3.extent(e.nodes,function(a){return a.y}),j=b-f.left-f.right,l=c-f.top-f.bottom,m=j/(g[1]-g[0]),n=l/(h[1]-h[0]),o=Math.min(m,n);e.nodes.forEach(function(a){a.pos=[a.x*o,a.y*o]});var p=.2*o,q=a.attr("width",Math.max(250,o*(g[1]-g[0])+f.left+f.right)).attr("height",o*(h[1]-h[0])+f.top+f.bottom).appendOnce("g","map-container").attr("transform","translate("+f.left+","+f.top+")");q.appendOnce("text","time-display").attr("x",.55*a.attr("width")).attr("y",.55*a.attr("height"));var s=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){return a.name});q.call(s);var t=q.selectAll(".station").data(e.nodes,function(a){return a.name}),u=q.selectAll(".connect").data(e.links,function(a){return(a.source&&a.source.id)+"-"+(a.target&&a.target.id)});u.enter().append("line").attr("class",function(a){return"connect "+a.line}),u.attr("x1",function(a){return a.source.pos[0]}).attr("y1",function(a){return a.source.pos[1]}).attr("x2",function(a){return a.target.pos[0]}).attr("y2",function(a){return a.target.pos[1]}),t.enter().append("circle").attr("class",function(a){return"station middle station-label "+a.id}).on("mouseover",function(a){a.pos[1]<30?s.direction("e").offset([0,10]):s.direction("n").offset([-10,0]),s.show(a)}).on("mouseout",s.hide),t.attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}).attr("r",2),d("place-asmnl","red"),d("place-alfcl","red"),d("place-brntn","red"),d("place-wondl","blue"),d("place-bomnl","blue"),d("place-forhl","orange"),d("place-ogmnl","orange"),k&&i(r,!0)}var k,l={},m={};e.nodes.forEach(function(a){a.x=f[a.id][0],a.y=f[a.id][1],l[a.id]=a}),e.links.forEach(function(a){a.source=e.nodes[a.source],a.target=e.nodes[a.target],a.source.links=a.source.links||[],a.target.links=a.target.links||[],a.target.links.splice(0,0,a),a.source.links.splice(0,0,a),m[a.source.id+"|"+a.target.id]=a.line,m[a.target.id+"|"+a.source.id]=a.line}),VIZ.watchSize(function(e,f){g.domain([a,e]).range([a,e]);var h=g(f),i=c.outerHeight(),k=b.width();j(d,k,h-i)});var n=2,o=moment("2014/02/03 07:00 -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3,p=moment("2014/02/04 02:00 -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3,q=10;VIZ.requiresData(["json!data/marey-trips.json"]).progress(function(){}).onerror(function(){}).done(function(a){k=a,i(r,!0),function b(){i(r>p?o:r+60/q),setTimeout(b,1e3/q)}()});var r=o}),VIZ.watchSize(function(d,e){g.domain([a,d]).range([a,d]);{var f=g(e);c.outerHeight(),b.width()}b.css("height",f+"px")})}(),VIZ.requiresData(["json!data/station-network.json","json!data/spider.json","json!data/marey-trips.json","json!data/marey-header.json"]).progress(function(a){"use strict";d3.selectAll(".marey, .lined-up-marey").text("Loading train data... "+a+"%").style("text-align","center")}).onerror(function(){"use strict";d3.select(".marey, .lined-up-marey").text("Error loading train data").style("text-align","center")}).done(function(a,b,c,d){"use strict";function e(){w.classed("highlight-active",!!F),w.selectAll(".highlightable").classed("active",function(a){return a.trip===F})}function f(a){F=a.trip,e(),d3.event.stopPropagation()}function g(){G=null,j()}function h(a){G=a.trip,j()}function i(){var a=L.extent()[0]/1e3,b=L.extent()[1]/1e3;d3.selectAll(".lined-up .mareyline").style("opacity",function(c){return a<c.secs&&b>c.secs?.7:.1})}function j(){d3.selectAll(".hoverable").classed("hover",function(a){return a.trip===G})}function k(b,c,d){function e(a,b){o.selectAll("circle."+a).classed(b,!0).classed("end",!0).classed("middle",!1).attr("r",Math.max(n,3))}var f={top:30,right:30,bottom:10,left:10},g=d3.extent(a.nodes,function(a){return a.x}),h=d3.extent(a.nodes,function(a){return a.y}),i=c-f.left-f.right,j=Math.max(d-f.top-f.bottom-$(".side-caption").height()-20,100),k=i/(g[1]-g[0]),l=j/(h[1]-h[0]),m=Math.min(k,l);a.nodes.forEach(function(a){a.pos=[a.x*m,a.y*m]});var n=.2*m;d3.select(".fixed-left").style("width",c+"px");var o=b.attr("width",m*(g[1]-g[0])+f.left+f.right).attr("height",m*(h[1]-h[0])+f.top+f.bottom).appendOnce("g","map-container").attr("transform","translate("+f.left+","+f.top+")"),p=o.selectAll(".station").data(a.nodes,function(a){return a.name}),q=o.selectAll(".connect").data(a.links,function(a){return(a.source&&a.source.id)+"-"+(a.target&&a.target.id)});q.enter().append("line").attr("class",function(a){return"connect "+a.line+"-dimmable"}).attr("x1",function(a){return a.source.pos[0]}).attr("y1",function(a){return a.source.pos[1]}).attr("x2",function(a){return a.target.pos[0]}).attr("y2",function(a){return a.target.pos[1]}),q.attr("x1",function(a){return a.source.pos[0]}).attr("y1",function(a){return a.source.pos[1]}).attr("x2",function(a){return a.target.pos[0]}).attr("y2",function(a){return a.target.pos[1]}),p.enter().append("circle").attr("class",function(a){return"station middle station-label "+a.id}).on("mouseover",function(a){a.pos[1]<30?E.direction("e").offset([0,10]):E.direction("n").offset([-10,0]),E.show(a),M(a.id,_.unique(a.links.map(function(a){return a.line})))}).on("mouseout",function(a){E.hide(a),M(null)}).attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}).attr("r",3),p.attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}).attr("r",3),e("place-asmnl","red"),e("place-alfcl","red"),e("place-brntn","red"),e("place-wondl","blue"),e("place-bomnl","blue"),e("place-forhl","orange"),e("place-ogmnl","orange")}function l(a,b,c){var d=x[a.stop].pos,e=x[b.stop].pos,f=d3.interpolate(d,e)(c),g=Math.atan2(e[1]-d[1],e[0]-d[0])+Math.PI/2;return[f[0]+Math.cos(g)*z,f[1]+Math.sin(g)*z]}function m(a){if(a||(a=N),N=a,v){var b=c.filter(function(b){return b.begin<a&&b.end>a}),d=b.map(function(b){for(var c=0;c<b.stops.length-1&&!(b.stops[c+1].time>a);c++);var d=b.stops[c],e=b.stops[c+1],f=(a-d.time)/(e.time-d.time);return{trip:b.trip,pos:l(d,e,f),line:b.line}}),e=s.select(".map-container").selectAll(".train").data(d,function(a){return a.trip});e.enter().append("circle").attr("class",function(a){return"train highlightable hoverable dimmable "+a.line}).classed("active",function(a){return a.trip===F}).classed("hover",function(a){return a.trip===G}).attr("r",z).on("click",function(a){f(a)}).on("mouseover",h).on("mouseout",g),e.attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}),e.exit().remove(),u.text(moment(1e3*a).format("h:mm a"))}}function n(b,e){function j(a){a.attr("transform",function(a){return"translate("+S(a)+",-10)"})}function k(a,b,c,e){var f=null,g=c.stops.map(function(a){var b;return b=f&&"place-jfk"===f.stop&&"place-nqncy"===a.stop?[null,{stop:"place-asmnl",time:f.time},a]:f&&"place-nqncy"===f.stop&&"place-jfk"===a.stop?[{stop:"place-asmnl",time:a.time},null,a]:[a],f=a,b}),h=_.flatten(g),i=a(d[c.stops[0].stop+"|"+c.line][0]),j=h.map(function(f){if(!f)return null;var g=b(f.time)-b(h[0].time),j=a(d[f.stop+"|"+c.line][0]);return e&&(j-=i),[j,g]});return j}function l(a,b,c){return function(d){var e=k(a,b,d,c);return Kb(e)}}function n(a,b,c,d){var e=a.selectAll(".point").data(function(a){var d=k(b,c,a,!0).filter(function(a){return!!a}),e=S(a.stops[0].stop);return d.forEach(function(a){a.offset=e}),d},function(a,b){return b});e.enter().append("circle").attr("r",2).attr("class","point"),(d?e.transition().duration(o):e).attr("cx",function(a){return a.offset+a[0]}).attr("cy",function(a){return a[1]})}function r(a,b,c){var e=a.selectAll(".text").data(function(a){var e=b(d[a.stops[0].stop+"|"+a.line][0]),f=(T[A.stops[0].stop].anchor,a.stops.map(function(f){if(!f)return null;var g=c(f.time)-c(a.stops[0].time),h=b(d[f.stop+"|"+a.line][0])-e;return{stop:f,x:h,y:g,dytop:-1,dybottom:9}})),g=-10;return _.sortBy(f,"y").forEach(function(a){g+=9,g>a.y+a.dybottom&&(a.dybottom=g-a.y),g=a.y+a.dybottom}),g=1e3,_.sortBy(f,"y").reverse().forEach(function(a){g-=9,g<a.y+a.dytop&&(a.dytop=g-a.y),g=a.y+a.dytop}),f},function(a,b){return b}),f=e.enter().append("g").attr("class","text");f.append("text").attr("dx",function(){return"beginning"===T[A.stops[0].stop].anchor?2:-2}).attr("dy",function(a){return a.dytop}).text(function(a){return x[a.stop.stop].name.replace(/ station/i,"")}).attr("text-anchor",function(){return T[A.stops[0].stop].anchor}),f.append("text").attr("dx",function(){return"beginning"===T[A.stops[0].stop].anchor?-2:2}).attr("dy",function(a){return a.dybottom}).text(function(a){return moment(1e3*a.stop.time).format("h:mma")}).attr("text-anchor",function(){return"beginning"===T[A.stops[0].stop].anchor?"end":"beginning"}),e.attr("transform",function(a){var b=A.stops[0].stop,c=S(b);return"translate("+(a.x+c)+","+a.y+")"}).style("opacity",0),e.transition().delay(o-300).duration(300).style("opacity",1)}function s(a,b){a.oldDomain=a.oldDomain||a.domain(),a.domain(b)}function t(a,b){a.oldRange=a.oldRange||a.range(),a.range(b)}function v(a){a.oldDomain&&a.domain(a.oldDomain),a.oldRange&&a.range(a.oldRange),a.oldDomain=null,a.oldRange=null}function y(a,b,c){var e=c?0:o;if(A=A||a,v(cb),v(bb),v(S),W=X,q=b,A&&q){var f=1.1*(A.end-A.begin);s(cb,[0,1e3*f]),s(bb,[0,f]);var g=A.stops[0],h=A.stops[A.stops.length-1],i=S(g.stop),k=i+zb(d[h.stop+"|"+A.line][0])-zb(d[g.stop+"|"+A.line][0]),l=T[g.stop].anchor,m=d3.scale.linear().domain([i,k]).range("beginning"===l?[50,ob-50]:[ob-50,50]);t(S,S.range().map(m)),W=X*(m(1)-m(0)),qb.selectAll(".mareyannotation").remove(),(c?yb:yb.transition().duration(e)).call(j).style("opacity",0)}else(c?yb:yb.transition().duration(e)).call(j).style("opacity",1);rb.selectAll(".mareynames").call(r,F,bb),xb.transition().duration(e).call(wb),rb.selectAll("g.mareystops").call(n,F,bb,!c),(c?Nb:Nb.transition().duration(e)).call(G),E()}function z(a){if(!q){E(),A=a;var b=(qb.appendOnce("text","mareyannotation"),a.stops[a.stops.length-1]),c=a.stops[0],d=sb(c.stop),e=S(c.stop),f=bb(b.time-c.time);qb.appendOnce("text","mareyannotation start").attr("x",e+("beginning"===T[c.stop].anchor?5:-5)).attr("y",-2).style("text-anchor",T[c.stop].anchor).text(moment(1e3*c.time).format("h:mma")),qb.appendOnce("text","mareyannotation clickme").attr("x",d).attr("y",16).style("text-anchor","middle").classed("light-markup",!0).text("Click for details"),qb.appendOnce("text","mareyannotation end").attr("x",d).attr("y",f+15).style("text-anchor","middle").text(moment(1e3*b.time).format("h:mma")),qb.appendOnce("text","mareyannotation time").attr("x",d).attr("y",f+30).style("text-anchor","middle").text(Math.round((b.time-c.time)/60)+"m"),rb.selectAll("g.mareystops").data([a]).enter().append("g").attr("class","mareystops").call(n,F,bb),rb.selectAll("g.mareynames").data([a]).enter().append("g").attr("class","mareynames"),qb.selectAll(".mareyline").classed({highlight:function(b){return b===a},dimmed:function(b){return b!==a}})}}function E(){A&&!q&&(A=null,qb.selectAll(".mareyannotation").remove(),rb.selectAll("*").remove(),qb.selectAll(".mareyline").classed({highlight:!1,dimmed:!1}))}function F(a){return W*zb(a)*ob/hb}function G(a){a.attr("transform",function(a){var b=S(a.stops[0].stop);return"translate("+b+",0)"}).attr("d",l(F,bb,!0))}function U(){var a=d3.mouse(kb.node()),b=a[0],c=Eb[Math.round(zb.invert(b))];c&&M(c)}function V(){var a=d3.mouse(kb.node()),b=a[1],c=a[0];if(c>0&&hb>c){var d=Ab.invert(b);eb(d)}}function eb(a){var b=Ab(a);Rb.attr("transform","translate(0,"+b+")"),u.text(moment(1e3*a).format("h:mm a")),m(a)}if(e!==db){db=e,v(bb),v(S),v(cb),W=X,e=Math.round(e);var fb={top:100,right:200,bottom:0,left:60},gb=3500,hb=e-fb.left-fb.right,ib=gb-fb.top-fb.bottom;b.attr("width",e).attr("height",gb);var jb=b.appendOnce("g","header").attr("transform","translate("+fb.left+",0)"),kb=b.appendOnce("g","main").attr("transform","translate("+fb.left+", "+fb.top+")"),lb=kb.appendOnce("g","background"),kb=kb.appendOnce("g","foreground"),mb=b.appendOnce("g","annotations").attr("transform","translate("+fb.left+", "+fb.top+")"),nb=$(".lined-up-marey-container .container").width(),ob=nb-H.left-H.right,pb=d3.select(".lined-up-marey").appendOnce("svg","lined-up").attr("width",nb).attr("height",I),qb=pb.appendOnce("g","g"),rb=pb.appendOnce("g","overlay");qb.firstTime.attr("transform","translate("+H.left+","+H.top+")"),rb.firstTime.attr("transform","translate("+H.left+","+H.top+")"),S.range(Y.map(function(a){return a*ob}));var sb=d3.scale.ordinal().domain(R).range(Z.map(function(a){return a*ob}));bb.range([0,J]),cb.range([0,J]);var tb=d3.svg.axis().scale(K).tickFormat(d3.time.format.utc("%-I %p")).orient("left").ticks(d3.time.hour,1),ub=qb.appendOnce("g","time axis").attr("transform","translate(-40,0)").call(tb);ub.on("mousemove.brush",function(){var a=d3.mouse(ub.node())[1],b=K.invert(a);L.extent([b.getTime()-36e5,b.getTime()+36e5]),d3.selectAll("g.brush").call(L).on("mousedown.brush",null).on("touchstart.brush",null),i()}),ub.appendOnce("g","brush").firstTime.call(L).call(i).on("mousedown.brush",null).on("touchstart.brush",null).selectAll("rect").attr("x",-45).attr("width",50);var vb=d3.time.format("%-Mm"),wb=d3.svg.axis().tickFormat(function(a){return Math.round(a/1e3/60)+"m"}).innerTickSize(-ob).outerTickSize(0).ticks(d3.time.minutes,10).scale(cb).orient("left"),xb=qb.appendOnce("g","y axis").call(wb);xb.appendOnce("text","label light-markup").attr("transform","rotate(90)translate("+J/2+",-5)").attr("text-anchor","middle").text("minutes since start of trip"),qb.appendOnce("text","top-label light-markup").text("Starting Station").attr("text-anchor","middle").attr("x",ob/2).attr("y",-24),qb.appendOnce("text","bottom-label light-markup").text("Ending Station").attr("text-anchor","middle").attr("x",ob/2).attr("y",J-5);var yb=qb.selectAll(".station-header").data(R.filter(function(a){return T[a].text}));yb.enter().append("g").attr("class","station-header").append("text").attr("text-anchor",function(a){return T[a].anchor}).attr("dx",function(a){return"beginning"===T[a].anchor?-4:4}).attr("dy",-2).text(function(a){return T[a].text}),yb.call(j);var zb=d3.scale.linear().domain(O).range([0,hb]),Ab=d3.scale.linear().domain([P,Q]).range([15,ib]).clamp(!0),Bb=d3.time.scale().domain([new Date(1e3*P),new Date(1e3*Q)]).range([15,ib]),Cb=d3.keys(d),Db=d3.scale.ordinal().domain(Cb).range(Cb.map(function(a){return zb(d[a][0])})),Eb={};Cb.forEach(function(a){Eb[d[a][0]]=a});var Fb=jb.selectAll(".station-label").data(D).enter().append("text").attr("class","station-label").style("display",function(a){return C[a]?null:"none"}).style("text-anchor","beginning").text(function(a){return B[a].replace(/ station/i,"")});Fb.attr("transform",function(a){return"translate("+(Db(a)-2)+","+(fb.top-3)+")rotate(-70)"});var Gb=mb.selectAll(".annotation").data(p);Gb.enter().append("g").attr("class","annotation").append("text").attr("id",function(a){return a.id}).text(function(a){return a.text}).call(VIZ.wrap,fb.right-20);var Hb=Gb.selectAll(".annotation-connection").data(function(a){return(a.connections||[]).map(function(b){return b.parent=a,b})});Hb.enter().append("path").attr("class","annotation-connection"),Hb.attr("d",function(b){var c=a.nodes.find(function(a){return new RegExp(b.station,"i").test(a.name)}),e=Ab(moment(b.parent.time+" -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3)-4,f=Ab(moment(b.start+" -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3),g=Ab(moment(b.stop+" -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3),h=Ab(moment(b.time+" -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3),i=zb(d[c.id+"|"+b.line][0]);return"M"+[[[hb+10,e],[b.time?i:i+3,b.time?h:(f+g)/2]],b.time?null:[[i,f],[i+3,f],[i+3,g],[i,g]]].filter(function(a){return!!a}).map(function(a){return a.map(function(a){return a.map(Math.round).join(",")}).join("L")}).join("M")}),mb.selectAll("text, text tspan").attr("x",hb+15).attr("y",function(a){return Ab(moment(a.time+" -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3)});var Ib=kb.selectAll(".station").data(D,function(a){return a});Ib.enter().append("line").attr("class",function(a){return"station "+a.replace("|","-")}),Ib.attr("x1",function(a){return zb(d[a][0])}).attr("x2",function(a){return zb(d[a][0])}).attr("y1",0).attr("y2",ib);var vb=d3.time.format("%-I:%M %p"),Jb=d3.svg.axis().tickFormat(vb).ticks(d3.time.minute,15).scale(Bb).orient("left");kb.appendOnce("g","y axis").call(Jb);var Kb=d3.svg.line().x(function(a){return a[0]}).y(function(a){return a[1]}).defined(function(a){return null!==a}).interpolate("linear"),Lb=(d3.svg.area().x(function(a){return a[0]}).y(function(a){return a[1]}).defined(function(a){return null!==a}).interpolate("linear"),kb.selectAll(".mareyline").data(c,function(a){return a.trip})),Mb=qb.appendOnce("g","mareylinecontainer");Mb.firstTime.attr("clip-path","url(#mareyClip)"),qb.appendOnce("defs","defs").appendOnce("clipPath","clip").attr("id","mareyClip").appendOnce("rect","clipRect").attr("width",ob).attr("height",J);var Nb=Mb.selectAll(".mareyline").data(ab,function(a){return a.trip}),Ob=null;qb.off("mouseover mouseout").onOnce("mouseover","path",function(a){clearTimeout(Ob),z(a),d3.select(this).moveToFront()}).onOnce("mouseout","path",function(){clearTimeout(Ob),Ob=setTimeout(E,100)}),d3.selectAll(".lined-up-marey").on("click.toggle",function(){y(null,!q)}),y(A,q,!0),kb.firstTime.onOnce("mouseover","path.mareyline",h).onOnce("mouseout","path.mareyline",g).onOnce("click","path.mareyline",f),Lb.enter().append("path").attr("class",function(a){return"mareyline hoverable highlightable dimmable "+a.line}),Nb.enter().append("path").attr("class",function(a){return"mareyline "+a.line}),Lb.attr("transform",function(a){return a.origY||(a.origY=Ab(a.stops[0].time)),"translate(0,"+a.origY+")"}).attr("d",l(zb,Ab)),Nb.call(G),w.on("mousemove",V),w.on("mousemove.titles",U);var Pb=lb.appendOnce("g","g-bar hide-on-ios"),Qb=kb.appendOnce("g","g-bar hide-on-ios");Pb.appendOnce("line","bar").attr("x1",1).attr("x2",hb).attr("y1",0).attr("y2",0),Qb.appendOnce("rect","text-background").firstTime.attr("x",3).attr("y",-14).attr("width",45).attr("height",12),Qb.appendOnce("text","marey-time").firstTime.attr("dx",2).attr("dy",-4),u=w.selectAll(".marey-time");var Rb=w.selectAll("g.g-bar");N||eb(P)}}var o=1e3,p=[{time:"2014/02/03 05:00",text:"Service starts at 5AM on Monday morning. Each line represents the path of one train. Time continues downward, so steeper lines indicate slower trains. <br> â–¾"},{time:"2014/02/03 05:55",text:'Since the red line splits, we show the Ashmont branch first then the Braintree branch.  Trains on the Braintree branch "jump over" the Ashmont branch.',connections:[{time:"2014/02/03 05:40",station:"ashmont",line:"red"}]},{time:"2014/02/03 06:30",text:"Train frequency increases around 6:30AM as morning rush hour begins.",id:"marey-morning-rush"},{time:"2014/02/03 11:30",text:"After the morning rush-hour subsides, everything runs smoothly throughout the middle of the day",id:"marey-midday-lull"},{time:"2014/02/03 15:30",text:"The afternoon rush hour begins around 3:30PM",id:"marey-evening-rush"},{time:"2014/02/03 17:00",text:"A disabled train causes delays on trains after (below) it for over an hour.  Notice how this causes delays in the other direction as well, as trains immediately arrive at Alewife then turn around to go south.",connections:[{start:"2014/02/03 17:02",stop:"2014/02/03 18:07",station:"JFK",line:"red"}]},{time:"2014/02/03 18:20",text:"Service to Bowdoin stops at 6:20PM",connections:[{time:"2014/02/03 18:20",station:"Bowdoin",line:"blue"}]},{time:"2014/02/03 19:00",text:"Normal service resumes for the evening starting around 7PM",id:"marey-evening-lull"},{time:"2014/02/03 20:50",text:"A disabled train at Wellington Station causes northbound delays on the Orange Line from 8:50PM to 9:15PM",connections:[{start:"2014/02/03 20:50",stop:"2014/02/03 21:15",station:"Community College",line:"orange"}]},{time:"2014/02/03 21:20",text:"Notice how southbound trains are temporarily delayed, but get back on schedule quickly."},{time:"2014/02/04 01:30",text:"The last trains of the night finish around 1:30AM"},{time:"2014/02/04 02:30",text:"At night, trains are moved between stations",connections:[{start:"2014/02/04 01:56",stop:"2014/02/04 02:03",station:"Orient Heights",line:"blue"},{start:"2014/02/04 03:59",stop:"2014/02/04 04:25",station:"JFK",line:"red"}]},{time:"2014/02/04 05:15",text:"At 5AM on Tuesday, the cycle begins again"}],q=!1,r=d3.select(".fixed-left"),s=r.select(".side-map").append("svg"),t=d3.select(".marey").text("").style("text-align","left").append("svg");d3.select(".lined-up-marey").text("");var u,v,w=d3.select(".marey-container").classed("loading",!1),x={},y={},z=2.5,A=null;r.selectAll(".scrollto").on("click",function(){var a=d3.select(this).attr("data-dest"),b=$("html, body");b.animate({scrollTop:$("#"+a).offset().top},"300","swing"),d3.event.preventDefault()}),r.selectAll(".highlight").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=d3.select(this).attr("data-line"),b=_.without(["red","orange","blue"],a);b.forEach(function(a){w.selectAll("."+a+", ."+a+"-dimmable, circle.middle").classed("line-dimmed",!0)})}).on("mouseout",function(){w.selectAll(".line-dimmed").classed("line-dimmed",!1)}),a.nodes.forEach(function(a){a.x=b[a.id][0],a.y=b[a.id][1],x[a.id]=a}),a.links.forEach(function(b){b.source=a.nodes[b.source],b.target=a.nodes[b.target],b.source.links=b.source.links||[],b.target.links=b.target.links||[],b.target.links.splice(0,0,b),b.source.links.splice(0,0,b),y[b.source.id+"|"+b.target.id]=b.line,y[b.target.id+"|"+b.source.id]=b.line
}),c.forEach(function(a){a.stops=a.stops||[];var b=moment(1e3*a.begin);a.secs=b.diff(b.clone().startOf("day"))/1e3});var B={},C={},D=a.nodes.map(function(a){return a.links.map(function(b){var c=a.id+"|"+b.line;return 1===a.links.length&&(C[c]=!0),B[c]=a.name,c})});D=_.unique(_.flatten(D));var E=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){return a.name});t.call(E);var F=null,G=null,H={top:50,right:40,bottom:30,left:80},I=400,J=I-H.top-H.bottom,K=d3.time.scale().domain([0,864e5]).range([0,J]).clamp(!0),L=d3.svg.brush().y(K).extent([252e5,324e5]).clamp(!0).on("brush",i);d3.select("body").on("click.highlightoff",function(){F=null,e()});var M=function(a,b){var c={};c[a]=!0,b?b.forEach(function(b){c[a+"|"+b]=!0}):a&&(c[a]=!0,c[a.replace(/\|.*/,"")]=!0);var d=t.selectAll("text.station-label");d.style("display",function(a){var b=C[a]||c[a];return b?null:"none"}),d.classed("active",function(a){return c[a.id?a.id:a]})},N=P,O=d3.extent(d3.values(d),function(a){return a[0]}),P=d3.min(d3.values(c),function(a){return a.begin}),Q=d3.max(d3.values(c),function(a){return a.end}),R=["place-alfcl","place-asmnl","place-brntn","place-wondl","place-gover","place-bomnl","place-ogmnl","place-forhl"],S=d3.scale.ordinal().domain(R),T={"place-alfcl":{text:"Alewife",anchor:"beginning"},"place-asmnl":{text:"Ashmont/Braintree",anchor:"end"},"place-brntn":{anchor:"end"},"place-wondl":{text:"Wonderland",anchor:"beginning"},"place-gover":{text:"Gov't Center",anchor:"end"},"place-bomnl":{anchor:"end"},"place-ogmnl":{text:"Orient Heights",anchor:"beginning"},"place-forhl":{text:"Forest Hills",anchor:"end"}},U=.02,V=.07,W=.52*(1-3*V-2*U),X=W,Y=function(){var a=21,b=11,c=18,d=a+b+c,e=1-3*V-2*U,f=e*a/d/2,g=e*c/d/2;return[0,2*f+V,2*f+V,2*f+V+U,1-2*g-V-U,1-2*g-V-U,1-2*g-V,1]}(),Z=[d3.mean([Y[0],Y[1]]),d3.mean([Y[0],Y[1]]),d3.mean([Y[0],Y[1]]),d3.mean([Y[3],Y[4]]),d3.mean([Y[3],Y[4]]),d3.mean([Y[3],Y[4]]),d3.mean([Y[6],Y[7]]),d3.mean([Y[6],Y[7]])],ab=c.filter(function(a){return _.contains(R,a.stops[0].stop)}),bb=d3.scale.linear().domain([0,d3.max(ab,function(a){return a.stops[a.stops.length-1].time-a.stops[0].time})]),cb=d3.time.scale().domain([0,d3.max(ab,function(a){return 1e3*(a.stops[a.stops.length-1].time-a.stops[0].time)})]);d3.selectAll(".lined-up-highlight").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=+d3.select(this).attr("data-lo"),b=+d3.select(this).attr("data-hi");L.extent([60*a*60*1e3,60*b*60*1e3]),d3.selectAll("g.brush").call(L).on("mousedown.brush",null).on("touchstart.brush",null),i()});var db=null;!function(){function a(){j=w,v=!1,t.style("margin-left",j+"px"),s.style("display","none"),n(t,p)}function b(){v=!0,j=i+p/3,t.style("margin-left",j+"px"),s.style("display",null),k(s,p/3,g),n(t,2*p/3),m(),f()}function c(a,b){h=a,p=Math.min(h,u)-2*w,i=.5*(h-p),g=b,clearTimeout(q),q=setTimeout(d,10)}function d(){l=$(t.node()).offset().top+100,o=l-100+$(t.node()).height()-$(".fixed-left").height(),e()}function e(){859>=h||VIZ.ios?a():b()}function f(){l=x.offset().top+100,o=l-100+x.height()-y.height(),r.style("top",window.pageYOffset>o?o-window.pageYOffset+"px":window.pageYOffset<l?l-window.pageYOffset+"px":null),r.style("left",Math.round(i)+"px")}var g,h,i,j,l,o,p,q,u=1e3,w=20,x=$(t.node()),y=$(".fixed-left");VIZ.watchSize(c),VIZ.ios||d3.select(window).on("scroll.fixed-left",f).call(f).call(d)}()}),VIZ.requiresData(["json!data/turnstile-heatmap.json","json!data/station-network.json","json!data/spider.json","json!data/turnstile-gtfs-mapping.json"]).progress(function(a){"use strict";d3.selectAll(".turnstile-all, .turnstile-total").text("Loading train data... "+a+"%").style("text-align","center")}).onerror(function(){"use strict";d3.selectAll(".turnstile-all, .turnstile-total").text("Error loading train data").style("text-align","center")}).done(function(a,b,c,d){"use strict";function e(b){var c=C.selectAll(".station-section").data(a.stops.filter(function(a){return E[a.name]}),function(a){return a.name}),d=c.enter().append("div").attr("class","station-section");d.append("svg").attr("width",v+w).attr("height",x-15).append("g").each(function(b,c){d3.select(this).call(j,c,b.name,b,a)}),d.append("p").attr("class","details").text(function(a){return p[a.name]}),c.exit().remove(),c.sort(function(a,b){return d3.descending(a.entrancesByType.all,b.entrancesByType.all)}),b&&Q.append("rect").style("fill","none").style("stroke","black").style("stroke-width","1px").style("opacity",1).attr("x",V).attr("y",S(b)).attr("width",2*u+5).attr("height",S.rangeBand()).transition().duration(500).style("opacity",0).attr("x",0).attr("y",O+200).attr("width",P).attr("height",x).remove()}function f(a){function c(a,b){p.selectAll("circle."+a).classed(b,!0).classed("end",!0).classed("middle",!1)}var f={top:20,right:30,bottom:10,left:10},i=d3.extent(b.nodes,function(a){return a.x}),j=d3.extent(b.nodes,function(a){return a.y}),k=300-f.left-f.right,l=300-f.top-f.bottom,m=k/(i[1]-i[0]),n=l/(j[1]-j[0]),o=Math.min(m,n);b.nodes.forEach(function(a){a.pos=[a.x*o,a.y*o]});var p=a.attr("width",o*(i[1]-i[0])+f.left+f.right).attr("height",o*(j[1]-j[0])+f.top+f.bottom).appendOnce("g","map-container").attr("transform","translate("+f.left+","+f.top+")");p.appendOnce("text","time-display").attr("x",.55*a.attr("width")).attr("y",.55*a.attr("height"));var s=d3.tip().attr("class","d3-tip text-center").offset([-10,0]).html(function(a){return a.name+"<br>Average "+d3.format(",")(d3.round(q[a.id],-2))+" entrances per day"});p.call(s);var t=p.selectAll(".station").data(b.nodes,function(a){return a.name}),u=p.selectAll(".connect").data(b.links,function(a){return(a.source&&a.source.id)+"-"+(a.target&&a.target.id)});u.enter().append("line").attr("class",function(a){return"connect "+a.line}),u.attr("x1",function(a){return a.source.pos[0]}).attr("y1",function(a){return a.source.pos[1]}).attr("x2",function(a){return a.target.pos[0]}).attr("y2",function(a){return a.target.pos[1]}),t.enter().append("circle").attr("class",function(a){return"station middle dimmable station-label "+a.id}).on("mouseover",function(a){a.pos[1]<30?s.direction("e").offset([0,10]):s.direction("n").offset([-10,0]),s.show(a),g(a.id)}).style("cursor","pointer").on("mouseout.tip",s.hide).on("mouseout.station",h).on("click",function(a){var b=_.invert(d)[a.id];E[b]||(E[b]=!0,e(b))}),t.attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}).attr("r",function(a){return r(q[a.id])}),c("place-asmnl","red"),c("place-alfcl","red"),c("place-brntn","red"),c("place-wondl","blue"),c("place-bomnl","blue"),c("place-forhl","orange"),c("place-ogmnl","orange")}function g(a,b){var c=d3.select(".section-people .viz");c.selectAll(b?".glyph":".right").classed("highlighting",!0),c.selectAll("."+a).classed("active",!0)}function h(){var a=d3.selectAll(".section-people .viz .glyph, .section-people .viz .right");a.classed("highlighting",!1),a.selectAll(".active").classed("active",!1)}function i(a){var b=a%12===0?12:a%12;return b+=a>=12?"pm":"am"}function j(a,b,c,d,f,g){setTimeout(function(){var b=["Sun","Mon","Tues","Wed","Thurs","Fri","Sat"],h=7*(u+A.right),i=(h+z.left+z.right,a.append("g").attr("transform","translate("+w+",0)")),j=a.append("g").attr("transform","translate("+w/2+",0)");j.append("text").attr("class","station header").attr("dy",25).text(c),j.append("text").attr("dy",45).attr("class","station total").text(d3.format(",")(d3.round(d.entrancesByType.all,-2))+" per day"),j.append("text").attr("dy",60).attr("class","station partial").text(d3.format(",")(d3.round(d.entrancesByType.weekday,-2))+" weekdays"),j.append("text").attr("dy",73).attr("class","station partial").text(d3.format(",")(d3.round(d.entrancesByType.offpeak,-2))+" weekends"),g||j.append("text").attr("dy",90).attr("class","station close").text("hide this station").on("click",function(a){E[a.name]=!1,e()});var k=i.selectAll(".dayLabel").data(b).enter().append("g").attr("class","xAxis");g&&k.append("text").attr("class","dayLabel").text(function(a){return a}).attr("dx",function(){return u/2}).attr("dy",0).style("text-anchor","middle");var o=d3.scale.ordinal().domain(["6am","12pm","6pm"]).rangePoints([0,u],2),p=d3.svg.axis().scale(o).orient("bottom").tickSize(-3);k.attr("transform",function(a,b){return"translate("+(3+z.left+(u+A.right)*b)+",0)"}).call(p);var q=i.append("g").attr("transform","translate("+z.left+","+z.top+")"),r=d3.scale.linear().domain([f.min,f.mean||.9*f.max,f.max]).range(["white","black","red"]),x=d3.scale.ordinal().rangeBands([0,u],0,0).domain(d3.range(0,24));["entrances","exits"].forEach(function(a,b){q.selectAll("."+a).data(d.times).enter().append("rect").attr("class",a).attr("x",function(a){return(u+A.right)*m(a)+x(l(a))}).attr("y",function(a){return(t+A.bottom)*(n(a)+5*b)}).attr("width",s).attr("height",t).attr("fill",function(b){return r(b[a])})}),q.append("text").attr("x",-3).attr("dy",-3).attr("text-anchor","end").attr("class","weeklabel light-markup small").text("Week"),q.selectAll(".grp").data([0,1]).enter().append("g").attr("class","grp").attr("transform",function(a){return"translate(0,"+5*(t+A.bottom)*a+")"}).selectAll(".weeklabel").data([0,1,2,3]).enter().append("text").attr("class","weeklabel light-markup small").attr("x",-3).attr("dy",6).attr("text-anchor","end").attr("y",function(a){return(t+A.bottom)*a}).text(function(a){return a+1}),i.append("text").attr("class","groupLabel").attr("transform","translate("+(v-10)+",5)rotate(90)").text("entrances").style("text-anchor","beginning"),i.append("text").attr("class","groupLabel").attr("transform","translate("+(v-10)+","+8.5*t+")rotate(90)").text("exits").style("text-anchor","beginning"),i.onOnce("mouseover","rect",function(a){i.selectAll("rect").classed("hover",function(b){return a.day===b.day&&a.week===b.week&&a.hour===b.hour}),F.direction("w").offset([-3,-12]),F.show.call(this,a)}).onOnce("mouseout","rect",function(a){i.selectAll("rect").classed("hover",!1),F.direction("n").offset([-10,0]),F.hide.call(this,a)})})}function k(a,b,c,d){var e=150,f=v+w,g=(f-500)/2,h=70,i={top:25,right:g,bottom:0,left:w+z.left},j=(f-i.left-i.right,f-i.top-i.bottom,d3.scale.linear().domain(c).range(["white","black","red"])),k=d3.selectAll(a).style("text-align","center"),l=k.append("svg").attr("width",f).attr("height",h).append("g").attr("transform","translate("+i.left+","+i.top+")"),m=l.append("text").attr("y",10).text("Color shows average entrances/exits"),n=m.node().getComputedTextLength()+10,o=d3.scale.linear().domain(d3.extent(j.domain()).map(function(a){return a/60})).range([0,e]);VIZ.createColorScaleGradient(j,b);var p=l.append("g").attr("transform","translate("+n+",1)"),q=(p.append("rect").attr("width",e).attr("height",t).attr("fill","url(#"+b+")"),d3.svg.axis().scale(o).orient("bottom").tickValues(d).tickFormat(d3.format(",")).tickSize(4));p.append("g").attr("class","x axis").attr("transform",function(){return"translate(0,"+t+")"}).call(q).append("text").attr("text-anchor","beginning").attr("x",e+14).attr("dy",14).text("people per minute")}function l(a){return a.hour}function m(a){return a.day}function n(a){return a.week-1}function o(a,b){return moment(a.time).format("MMM D [from] ha")+" to "+moment(a.time).add(1,"hour").format("ha")+"<br>"+d3.format(",")(d3.round(a[b]/60,0))+" "+b+" per minute"}var p={"Suffolk Downs":"Suffolk Downs is the least-busy station and experiences very little traffic throughout the day","North Station":"North Stations experiences a lot of traffic spikes in the evening, since it is right by the TD Garden Arena, home of the Celtics and Bruins",Harvard:"Harvard is the busiest station and has a constant stream of people getting on and off the subway throughout the day","South Station":"In the heart of Boston's Financial District, South Station is a destination for people to go to work, but it is also at the end of the commuter rail and people who take that into the city must go through a turnstile after getting off the commuter rail to get to other parts of the city","Downtown Crossing":"Like South Station, Downtown Crossing is primarily a work destination, but it does not eperience the commuter-rail bump in entrances in the morning"};d3.selectAll(".turnstile-all, .turnstile-total").text("");var q={};a.stops.forEach(function(a){q[d[a.name]]=a.entrancesByType.all});var r=d3.scale.linear().domain(d3.extent(d3.values(q))).range([2,7]),s=3,t=8,u=24*s,v=7.5*u+10,w=150,x=9*t+40,y={top:15,right:0,bottom:0,left:0},z={top:10,right:0,bottom:0,left:20},A={top:0,right:2,bottom:2,left:0},B=d3.select(".turnstile-total").append("svg").attr("width",v+w).attr("height",x),C=d3.select(".turnstile-all"),D=B.append("g").attr("transform","translate("+y.left+","+y.top+")").call(j,0,"All Stations",a.all,a.all,!0),E={Harvard:!0,"South Station":!0,"Downtown Crossing":!0,"Park Street":!0,"North Station":!0};a.stops.sort(function(a,b){return d3.descending(a.entrancesByType.all,b.entrancesByType.all)}),e();var F=d3.tip().attr("class","d3-tip text-center").offset([-10,0]).html(function(a){return o(a,d3.select(this).classed("entrances")?"entrances":"exits")});D.call(F);var G={holidays:[[3,1]],snow:[[1,3],[2,4]]},H=B.selectAll(".highlight-group").data([2,7]).enter().append("g").attr("class",function(a){return"highlight-group num"+a}).attr("transform",function(a){return"translate("+(w+z.left+15)+","+(a*(A.bottom+t)-6)+")"});d3.selectAll(".section-people .highlight-total").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=d3.select(this).attr("data-highlight"),b=G[a];H.selectAll("rect.highlight").data(b).enter().append("rect").attr("class","highlight").attr("width",u-7).attr("height",t+2).attr("x",function(a){return(u+A.right)*a[1]}).attr("y",function(a){return(t+A.bottom)*a[0]}),B.selectAll(".num2").selectAll("line.highlight").data(b).enter().append("line").attr("class","highlight").attr("x1",function(a){return(u+A.right)*a[1]}).attr("x2",function(a){return(u+A.right)*a[1]}).attr("y1",function(a){return(t+A.bottom)*a[0]}).attr("y2",function(a){return(t+A.bottom)*a[0]+5*(A.bottom+t)})}).on("mouseout",function(){B.selectAll(".highlight").remove()}),d3.selectAll(".section-people .dim").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=d3.select(this).attr("data-dim");B.selectAll("."+a).style("opacity",.1)}).on("mouseout",function(){var a=d3.select(this).attr("data-dim");B.selectAll("."+a).style("opacity",1)});var I={},J={},K={};b.nodes.forEach(function(a){a.x=c[a.id][0],a.y=c[a.id][1],I[a.id]=a}),b.links.forEach(function(a){a.source=b.nodes[a.source],a.target=b.nodes[a.target],a.source.links=a.source.links||[],a.target.links=a.target.links||[],a.target.links.splice(0,0,a),a.source.links.splice(0,0,a),J[a.source.id+"|"+a.target.id]=a.line,J[a.target.id+"|"+a.source.id]=a.line,K[a.target.id]=K[a.target.id]||{},K[a.source.id]=K[a.source.id]||{},K[a.target.id][a.line]=!0,K[a.source.id][a.line]=!0}),d3.select(".section-people .glyph").append("svg").call(f),function(){var a={top:10,right:30,bottom:10,left:10},b=300-a.left-a.right,c=d3.selectAll(".section-people .viz .key").append("svg").attr("width",300).attr("height",50).append("g").attr("transform","translate("+a.left+","+a.top+")"),d=c.append("text").attr("x",b/2).attr("y",10).attr("text-anchor","middle");d.append("tspan").text("Size shows average turnstile entries");var e=[500,1e4,2e4],f=d3.scale.ordinal().domain(e).range([30,75,135]);c.selectAll("circle").data(e).enter().append("circle").attr("class","station middle").attr("r",function(a){return r(a)}).attr("cx",function(a){return f(a)-r(a)-2}).attr("cy",25),c.selectAll("text.num").data(e).enter().append("text").attr("class","num").text(d3.format(",")).attr("x",function(a){return f(a)}).attr("y",30),c.append("text").attr("text-anchor","beginning").attr("x",f(_.last(e))+37).attr("y",30).text("people per day")}();var L={top:20,right:20,bottom:10,left:30},M=600,N=700,O=N-L.top-L.bottom,P=M-L.left-L.right,Q=d3.select(".section-people .right").append("svg").attr("class","barchart").attr("width",M).attr("height",N).append("g").attr("transform","translate("+L.left+","+L.top+")"),R=d3.tip().attr("class","d3-tip text-center").offset([-10,0]);Q.call(R);var S=d3.scale.ordinal().domain(a.stops.map(function(a){return a.name})).rangeRoundBands([0,O],.2),T=Q.selectAll(".row").data(a.stops).enter().append("g").attr("class",function(a){return d[a.name]+" row dimmable"}).attr("transform",function(a){return"translate(0,"+S(a.name)+")"});T.append("rect").attr("width",P).attr("height",S.rangeBand()).attr("fill","white").attr("class","bounding-box"),d3.selectAll(".section-people .highlight").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=d3.select(this).attr("data-highlight"),b=d3.select(".section-people .right");b.selectAll(".highlight-dimmable").classed({dim:function(){return!d3.select(this).classed(a)},active:function(){return d3.select(this).classed(a)}})}).on("mouseout",function(){var a=d3.select(".section-people .right");a.selectAll(".dim").classed({dim:!1,active:!1})}),d3.selectAll(".section-people .highlight-stops").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=d3.select(this).attr("data-stops").split(",").map(function(a){return"."+d[a]}).join(", "),b=d3.select(".section-people .viz").selectAll(".glyph, .right");b.classed("highlighting",!0),b.selectAll(a).classed("active",!0)}).on("mouseout",h),T.on("mouseover",function(a){var b=d[a.name];g(b,!0)}).on("mouseout",function(){h()}).on("click",function(a){E[a.name]||(E[a.name]=!0,e(a.name))});var U=15,V=120,W=V+u+5,X=35,Y=[W+u+5+X,P],Z=d3.scale.linear().domain([0,d3.max(a.stops,function(a){return a.entrancesByType.all})]).range([0,Y[1]-Y[0]-50]);T.append("line").attr("class","bottom-edge").attr("x1",U).attr("x2",function(a){return Y[0]+Z(a.entrancesByType.all)}).attr("y1",S.rangeBand()+1).attr("y2",S.rangeBand()+1),T.append("text").attr("x",U).attr("y",S.rangeBand()).attr("class","highlight-dimmable").text(function(a){return a.name}).append("title").text("Click to show details below");var $=T.selectAll(".heatmaps").data(function(a){return[{parent:a,type:"entrances",day:"offpeak",x:W,y:0},{parent:a,type:"exits",day:"offpeak",x:W,y:S.rangeBand()/2},{parent:a,type:"entrances",day:"weekday",x:V,y:0},{parent:a,type:"exits",day:"weekday",x:V,y:S.rangeBand()/2}]}).enter().append("g").attr("class",function(a){return"heatmap highlight-dimmable "+a.type+" "+a.day}).attr("transform",function(a){return"translate("+a.x+","+a.y+")"});Q.selectAll(".dayLabel").data([["Line","end",U-3],["Station","beginning",U],["Avg. Weekday","middle",V+u/2,-5],["Avg. Weekend","middle",W+u/2,-5],["Avg. Turnstile Entries per day","beginning",Y[0]]]).enter().append("g").attr("class","xAxis").append("text").attr("class","dayLabel").attr("x",function(a){return a[2]}).attr("y",function(a){return a[3]||0}).text(function(a){return a[0]}).style("text-anchor",function(a){return a[1]});var ab=Q.selectAll(".hours").data([V,W]).enter().append("g").attr("class","hours xAxis"),bb=d3.scale.ordinal().domain(["6am","12pm","6pm"]).rangePoints([0,u],2),cb=d3.svg.axis().scale(bb).orient("bottom");ab.attr("transform",function(a){return"translate("+a+",-11)"}).call(cb);var db=d3.scale.ordinal().rangeBands([0,u],0,0).domain(d3.range(0,24)),eb=d3.scale.linear().domain([a.min,a.mean||.9*a.max,a.max]).range(["white","black","red"]);$.selectAll("rect").data(function(a){return a.parent.averagesByType[a.day].map(function(b){return{hour:b.hour,datum:b[a.type],name:a.parent.name,day:a.day,type:a.type}})}).enter().append("rect").attr("x",function(a){return db(a.hour)}).attr("width",s).attr("height",S.rangeBand()/2).attr("fill",function(a){return eb(a.datum)}),Q.onOnce("mouseover",".heatmap rect",function(a){var b=i(a.hour),c=i((a.hour+1)%24);R.html(a.name+" from "+b+" to "+c+" on average "+("weekday"===a.day?"weekday":"weekend/holiday")+"<br>"+d3.round(a.datum/60,0)+" "+a.type+" per minute"),R.show(a)}).onOnce("mouseout",".heatmap rect",R.hide),T.append("rect").attr("class","bar highlight-dimmable").attr("x",Y[0]).attr("width",function(a){return Z(a.entrancesByType.all)}).attr("height",S.rangeBand()+1),T.append("text").attr("x",function(){return Y[0]-10}).attr("text-anchor","end").attr("dx",5).attr("dy",S.rangeBand()).attr("class","highlight-dimmable").text(function(a){return d3.format(",")(d3.round(a.entrancesByType.all,-2))});var fb=["red","blue","orange"],gb=d3.scale.ordinal().domain([1,0]).rangePoints([0,10]);T.selectAll(".line").data(function(a){return fb.filter(function(b){return K[d[a.name]][b]})}).enter().append("circle").attr("r",3).attr("cx",function(a,b){return gb(b)}).attr("cy",S.rangeBand()-5).attr("class",function(a){return"highlight-dimmable line "+a}).on("mouseover",function(a){R.html(a+" line"),R.show(a)}).on("mouseout",R.hide),k(".turnstile.key","turnstileGradient",[0,.9*a.all.max,a.all.max],[0,200,400,600,d3.round(a.all.max/60,0)]),k(".turnstile-all-key.key","turnstileAllGradient",[0,a.mean,a.max],[0,20,40,60,d3.round(a.max/60,0)]);{var hb=d3.time.format("%Y-%m-%d %H:%M:%S");hb.parse("2014-01-26 00:00:00"),d3.time.format("%b %d, %H:%M")}}),VIZ.requiresData(["json!data/delay.json","json!data/station-network.json","json!data/spider.json","json!data/average-actual-delays.json"]).progress(function(a){"use strict";d3.selectAll(".interaction-all .loading").text("Loading delay data... "+a+"%").style("text-align","center")}).onerror(function(){"use strict";d3.select(".interaction-all .loading").text("Error loading delay data").style("text-align","center")}).done(function(a,b,c,d){"use strict";function e(a){var b,c=G[a.ids];return b=null===c||"undefined"==typeof c?"white":jb(c)}function f(){var a=d3.mouse(N.node())[0]-u.left,b=d3.mouse(N.node())[1];if(!(0>b||0>a||b>C||a>D)){var c=Math.max(1,d3.bisectLeft(P.range(),b))%7,d=Y.invert(a).getTime();g(c,d)}}function g(a,c){function f(a,b){var c=a+"|"+b;if(r.hasOwnProperty(c)){var e=r[c],f=d[c],g=f/e;G[c]=g}}var g=Y(c),h=P(a);mb.attr("transform","translate("+(g+u.left)+","+h+")"),nb.text(moment(c).utc().format("h:mm a"));var i=moment(c).utc().format("h:mm a")+" on "+moment.weekdaysShort()[a]+" Feb "+(a?a+2:9);M.text(i),d3.select(".interaction-all .time").text(i);var j=bb[a];G={};var k=qb(j,c/1e3)-1,l=(c-1)%rb/rb,m=j[k]||j[k+1],n=j[k+1]||m;H=d3.interpolate(m.ins,n.ins)(l),ob.text(d3.format("f")(d3.interpolate(m.ins_total,n.ins_total)(l))+" entries/min");var o=d3.interpolate(m.delay_actual,n.delay_actual)(l);pb.text(0>o?d3.format("%")(-o)+" fast":d3.format("%")(o)+" slow");var p=_.extend.apply(null,[{}].concat(_.pluck(m.lines,"delay_actual"))),q=_.extend.apply(null,[{}].concat(_.pluck(n.lines,"delay_actual"))),r=d3.interpolate(p,q)(l);b.links.forEach(function(a){f(a.source.id,a.target.id),f(a.target.id,a.source.id)}),L.selectAll(".connect path").attr("fill",e).attr("d",t)}function h(a,b){return a.links.map(function(c){var d,e;return c.target===a?(d=[c.source.pos,c.target.pos],e=c.source.id+"|"+c.target.id):(d=[c.target.pos,c.source.pos],e=c.target.id+"|"+c.source.id),{segment:d,line:c.line,ids:e,day:b}})}function i(a,b){return a.links.map(function(c){var d,e;return c.source===a?(d=[c.source.pos,c.target.pos],e=c.source.id+"|"+c.target.id):(d=[c.target.pos,c.source.pos],e=c.target.id+"|"+c.source.id),{segment:d,line:c.line,ids:e,day:b}})}function j(a,b){L.append("circle").attr("cx",hb*c[a][0]).attr("cy",hb*c[a][1]).attr("fill",b).attr("r",kb).attr("stroke","none")}function k(a,b){var c=o(a.segment);b=b||[];var d=null,e=1/0;return b.forEach(function(b){if(!m(b,a)){var f=o(b.segment)+Math.PI,g=-n(f-c);e>g&&(e=g,d=b)}}),d}function l(a,b){var c=o(a.segment);b=b||[];var d=null,e=1/0;return b.forEach(function(a){var b=o(a.segment),f=n(c-b),g=Math.abs(f);.2>g||Math.abs(g-Math.PI)<.2||e>f&&(e=f,d=a)}),d}function m(a,b){var c=JSON.stringify(a.segment),d=JSON.stringify(b.segment);return c===d}function n(a){return(4*Math.PI+a)%(2*Math.PI)-Math.PI}function o(a,b){if(1===arguments.length){var c=a;a=c[0],b=c[1]}return Math.atan2(b[1]-a[1],b[0]-a[0])}function p(a){var b=a.ids.split("|").map(function(a){var b=H[a];return ib(b||0)}),c=a.segment[0],d=a.segment[1],e=o(c,d),f=e+Math.PI/2,g=[d[0]+b[1]*Math.cos(f),d[1]+b[1]*Math.sin(f)],h=[c[0]+b[0]*Math.cos(f),c[1]+b[0]*Math.sin(f)];return[h,g]}function q(a){return(a[1][1]-a[0][1])/(a[1][0]-a[0][0])}function r(a){return a[1][1]-q(a)*a[1][0]}function s(a,b){var c,d,e=q(a),f=r(a),g=q(b),h=r(b),i=1/0===e||e===-1/0,j=1/0===g||g===-1/0;return i&&j||Math.abs(g-e)<.01?null:i?(c=a[0][0],d=g*c+h,[c,d]):j?(c=b[0][0],d=e*c+f,[c,d]):(c=(h-f)/(e-g),d=e*c+f,[c,d])}function t(a){var b,c=a.segment[0],d=a.segment[1],e=p(a),f=e[1],g=e[0];if(b=k(a,a.outgoing),b&&a.outgoing.length>1){var h=p(b),i=s(e,h);i&&(f=i)}if(b=l(a,a.incoming),b&&a.incoming.length>1){var j=p(b),m=s(e,j);m&&(g=m)}{var n=a.ids.split("|");n[0],n[1]}return I([c,d,f,g,c])}d3.select(".interaction-all .loading").remove();var u={top:20,right:70,bottom:60,left:50},v={top:20,right:20,bottom:25,left:20},w=300,x=300,y=x-v.left-v.right,z=w-v.top-v.bottom,A=600,B=350,C=B-u.top-u.bottom,D=A-u.left-u.right,E={},F={},G={},H={},I=d3.svg.line().x(function(a){return a[0]}).y(function(a){return a[1]}).defined(function(a){return!!a}).interpolate("linear");a.sort(function(a,b){return d3.ascending(a.msOfDay,b.msOfDay)}),b.links.forEach(function(a){a.source=b.nodes[a.source],a.target=b.nodes[a.target],a.source.links=a.source.links||[],a.target.links=a.target.links||[],a.target.links.splice(0,0,a),a.source.links.splice(0,0,a),E[a.source.id+"|"+a.target.id]=a.line,E[a.target.id+"|"+a.source.id]=a.line}),b.nodes.forEach(function(a){a.x=c[a.id][0],a.y=c[a.id][1],F[a.id]=a});var J=d3.extent(b.nodes,function(a){return a.x}),K=d3.extent(b.nodes,function(a){return a.y}),L=d3.select(".interaction-all .left .glyph").append("svg").attr("class","breathing-glyph dimmable").attr("width",x).attr("height",w).append("g").attr("transform","translate("+v.left+","+v.top+")"),M=L.append("text").attr("x",y/2).attr("y",z+20).attr("text-anchor","middle"),N=d3.select(".interaction-all .right").append("svg").attr("class","horizons").attr("width",A).attr("height",B).append("g").attr("transform","translate(0,"+u.top+")"),O=d3.range(0,7),P=d3.scale.ordinal().domain([1,2,3,4,5,6,0]).rangeRoundBands([0,C],.3),Q=N.selectAll(".row").data(O).enter().append("g").attr("class","row"),R=Q.append("g").attr("transform",function(a){return"translate("+u.left+","+P(a)+")"}),S=Q.append("g").attr("class",function(a){return"dimmable day-"+a}).attr("transform",function(a){return"translate("+u.left/2+","+P(a)+")"});S.append("text").attr("class","daylabel").attr("dy",P.rangeBand()-15).attr("text-anchor","middle").text(function(a){return moment.weekdaysShort()[a]}),S.append("text").attr("class","dayofmonthlabel").attr("dy",P.rangeBand()-2).attr("text-anchor","middle").text(function(a){return"Feb "+(2+(0===a?7:a))});var T="ins_total",U=7,V={top:0,right:0,bottom:U,left:0},W=D-V.left-V.right,X=P.rangeBand()-V.top-V.bottom,Y=d3.time.scale().domain([0,864e5]).range([0,W]).clamp(!0),Z=d3.svg.axis().scale(Y).tickFormat(d3.time.format.utc("%-I%p")).orient("top").ticks(d3.time.hours,2),$=(N.append("g").attr("class","x axis").attr("transform","translate("+u.left+",0)").call(Z),d3.horizon().width(W).height(X).yMax(1.1).bands(3).mode("offset").interpolate("basis"));$.color.domain([-4,0,4]).range(["#555","white","#555"]);var ab=R.append("g").attr("class","horizon-row").attr("transform","translate("+V.left+","+V.top+")");ab.selectAll(".horizon").data(function(b){var c=d3.min(a,function(a){return a[T]}),d=d3.max(a,function(a){return a[T]}),e=d3.scale.linear().domain([c,d]),f=[_.chain(a).where({day:b}).filter(function(a){return"number"==typeof a[T]}).map(function(a){return[a.msOfDay,e(a[T])]}).value()];return f[0].day=b,f}).enter().append("g").attr("class",function(a){return"horizon dimmable day-"+a.day}).call($);var bb=_.toArray(_.groupBy(a,"day")),cb=N.append("svg:defs").selectAll("linearGradient").data(bb).enter().append("svg:linearGradient").attr("id",function(a,b){return"gradient"+b}).attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("spreadMethod","pad"),db=d3.scale.linear().interpolate(d3.interpolateLab).domain([-.2,0,.4]).range(["rgb(0, 104, 55)","rgb(255, 255, 255)","rgb(165, 0, 38)"]),eb=d3.scale.linear().domain([0,86400]).range(["0%","100%"]);cb.selectAll("stop").data(function(a){return a}).enter().append("svg:stop").attr("offset",function(a){return eb(a.msOfDay+450)}).attr("stop-color",function(a){return db(a.delay_actual)}).attr("stop-opacity",1),ab.append("rect").attr("class",function(a){return"delay-rect dimmable day-"+a}).attr("y",X).attr("width",W).attr("height",U).attr("fill",function(a){return"url(#gradient"+a+")"});var fb=y/(J[1]-J[0]),gb=z/(K[1]-K[0]),hb=Math.min(fb,gb),ib=d3.scale.linear().domain([0,100]).range([.15*hb,.7*hb]),jb=d3.scale.linear().interpolate(d3.interpolateLab).domain([2,1,.3]).range(["rgb(0, 104, 55)","rgb(255, 255, 255)","rgb(165, 0, 38)"]),kb=.3*hb;b.nodes.forEach(function(a){a.pos=[a.x*hb,a.y*hb]});var lb=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){return a.name});L.call(lb),d3.select(".interaction-all .viz").on("mousemove",f),d3.selectAll(".interaction-all a.highlight").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=d3.select(this).attr("data-highlight");d3.selectAll(".interaction-all .viz").selectAll(a).classed("active",!0),d3.selectAll(".interaction-all .viz").classed("highlighting",!0)}).on("mouseout",function(){d3.selectAll(".interaction-all .viz .active").classed("active",!1),d3.selectAll(".interaction-all .viz").classed("highlighting",!1)}),d3.selectAll(".interaction-all a.set-time").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=+d3.select(this).attr("data-day"),b=d3.select(this).attr("data-time"),c=moment(b+" -0400","hh:mm a Z").diff(moment(b+" -0400","hh:mm a Z").startOf("day"));g(a,c)});var mb=N.append("g").attr("class","indicator dimmable").attr("transform","translate(-100,0)");mb.append("line").attr("x1",0).attr("x2",0).attr("y1",-10).attr("y2",P.rangeBand()+10);var nb=mb.append("text").attr("dx",-3).attr("dy",-1).attr("text-anchor","end"),ob=mb.append("text").attr("dx",3).attr("dy",-1).attr("text-anchor","beginning"),pb=mb.append("text").attr("dx",3).attr("dy",P.rangeBand()+10).attr("text-anchor","beginning"),qb=d3.bisector(function(a){return a.msOfDay}).left,rb=9e5;!function(){{var a=150,b=N.append("g").attr("class","dimmable delay-rect key");b.append("text").attr("text-anchor","middle").attr("y",6).text("Color shows delay")}b.attr("transform","translate("+(.15*D+u.left)+","+(C+20)+")");var c=d3.scale.linear().domain(d3.extent(db.domain())).range([0,a]);VIZ.createColorScaleGradient(db,"delayGradient");var d=b.append("g"),e=(d.append("rect").attr("x",-a/2).attr("y",10).attr("width",a).attr("height",6).attr("fill","url(#delayGradient)"),d3.svg.axis().scale(c).orient("bottom").tickFormat(function(a){var b=d3.format("%")(d3.round(a,1)),c=d3.format("%")(d3.round(-a,1));return 0>a?c+" faster":a>0?b+" slower":"on time"}).tickValues([d3.min(db.domain()),0,d3.max(db.domain())]).tickSize(4));d.append("g").attr("class","x axis").attr("transform",function(){return"translate("+-a/2+",16)"}).call(e).append("text").attr("text-anchor","beginning").attr("x",a+30).attr("dy",15).text("than normal")}(),function(){var a={top:5,right:v.right,bottom:10,left:v.left},b=300-a.left-a.right,c=d3.selectAll(".interaction-all .left .key").append("svg").attr("width",300).attr("height",60).append("g").attr("transform","translate("+a.left+","+a.top+")"),d=c.append("text").attr("x",b/2).attr("y",10).attr("text-anchor","middle");d.text("Line width shows turnstile entries at a station");var e=[0,50,100],f=d3.scale.ordinal().domain(e).range([33,77,130]),g=c.selectAll(".path").data(e).enter().append("g").attr("class","path connect").attr("transform",function(a){return"translate("+(f(a)-ib(a)-4)+",28)"});g.append("path").datum(function(a){return[[-ib(a),0],[.75*-ib(a),10],[.75*ib(a),10],[ib(a),0],[.75*ib(a),-10],[.75*-ib(a),-10],[-ib(a),0]]
}).style("stroke","none").style("fill",db(-.01)).attr("d",I),g.append("path").datum(function(a){return[[-ib(a),0],[.75*-ib(a),10],null,[.75*ib(a),10],[ib(a),0],[.75*ib(a),-10],null,[.75*-ib(a),-10],[-ib(a),0],null,[-ib(a),0],[ib(a),0],null,[0,10],[0,-10]]}).style("stroke","black").style("fill","none").attr("d",I),c.selectAll("text.num").data(e).enter().append("text").attr("class","num").text(d3.format(",")).attr("x",function(a){return f(a)}).attr("y",32),c.append("text").attr("text-anchor","beginning").attr("x",f(_.last(e))+20).attr("y",32).text("people per minute")}(),function(){{var b=150,c=N.append("g").attr("class","dimmable horizon key");c.append("text").attr("text-anchor","middle").attr("y",6).text("Gray bars show entries to all stations")}c.attr("transform","translate("+(3*D/4+u.left)+","+(C+20)+")");var d=c.append("g"),e=d3.max(a,function(a){return a.ins_total}),f=d3.scale.linear().domain([0,1].map(function(a){return a*e})).range([0,b]),g=d3.horizon().width(b).height(6).yMax(1.1*e).bands(3).mode("offset").interpolate("basis");g.color.domain([-4,0,4]).range(["#555","white","#555"]);var h=(d.append("g").attr("class","horizon-row").attr("transform","translate("+-b/2+",10)").selectAll(".horizon").data([[[0,0],[1,e]]]).enter().append("g").attr("class",function(a){return"horizon dimmable day-"+a.day}).call(g),d3.svg.axis().scale(f).orient("bottom").tickFormat(function(a){return d3.format(",")(d3.round(a,-1))}).tickValues([0,1.1*e/3,1.1*e*2/3,e]).tickSize(4));d.append("g").attr("class","x axis").attr("transform",function(){return"translate("+-b/2+",16)"}).call(h).append("text").attr("text-anchor","beginning").attr("x",b+16).attr("dy",14).text("people per minute")}();var sb=L.selectAll(".connect").data(function(a){return b.links.map(function(b){return{link:b,day:a}})}).enter().append("g").attr("class","connect");sb.append("g").attr("class",function(a){return a.link.line+"-glyph "+a.link.source.id+"-"+a.link.target.id}).append("path").datum(function(a){return{incoming:h(a.link.source),line:a.link.line,ids:a.link.source.id+"|"+a.link.target.id,segment:[a.link.source.pos,a.link.target.pos],outgoing:i(a.link.target),name:a.link.source.name+" to "+a.link.target.name}}).attr("fill",e).attr("d",t).on("mouseover.tip",lb.show).on("mouseout.tip",lb.hide),sb.append("g").attr("class",function(a){return a.link.line+"-glyph "+a.link.target.id+"-"+a.link.source.id}).append("path").datum(function(a){return{incoming:h(a.link.target),line:a.link.line,ids:a.link.target.id+"|"+a.link.source.id,segment:[a.link.target.pos,a.link.source.pos],outgoing:i(a.link.source),name:a.link.target.name+" to "+a.link.source.name}}).attr("fill",e).attr("d",t).on("mouseover.tip",lb.show).on("mouseout.tip",lb.hide),j("place-asmnl","#E12D27"),j("place-alfcl","#E12D27"),j("place-brntn","#E12D27"),j("place-wondl","#2F5DA6"),j("place-bomnl","#2F5DA6"),j("place-forhl","#E87200"),j("place-ogmnl","#E87200");var I=d3.svg.line().x(function(a){return a[0]}).y(function(a){return a[1]}).interpolate("linear")});