!function(a,b){"function"==typeof define&&define.amd?define(["d3"],b):a.d3.tip=b(a.d3)}(this,function(a){return function(){function b(a){u=o(a),v=u.createSVGPoint(),document.body.appendChild(t)}function c(){return"n"}function d(){return[0,0]}function e(){return" "}function f(){var a=p();return{top:a.n.y-t.offsetHeight,left:a.n.x-t.offsetWidth/2}}function g(){var a=p();return{top:a.s.y,left:a.s.x-t.offsetWidth/2}}function h(){var a=p();return{top:a.e.y-t.offsetHeight/2,left:a.e.x}}function i(){var a=p();return{top:a.w.y-t.offsetHeight/2,left:a.w.x-t.offsetWidth}}function j(){var a=p();return{top:a.nw.y-t.offsetHeight,left:a.nw.x-t.offsetWidth}}function k(){var a=p();return{top:a.ne.y-t.offsetHeight,left:a.ne.x}}function l(){var a=p();return{top:a.sw.y,left:a.sw.x-t.offsetWidth}}function m(){var a=p();return{top:a.se.y,left:a.e.x}}function n(){var b=a.select(document.createElement("div"));return b.style({position:"absolute",top:0,opacity:0,"pointer-events":"none","box-sizing":"border-box"}),b.node()}function o(a){return a=a.node(),"svg"==a.tagName.toLowerCase()?a:a.ownerSVGElement}function p(){var b=w||a.event.target,c={},d=b.getScreenCTM(),e=b.getBBox(),f=e.width,g=e.height,h=e.x,i=e.y;return v.x=h,v.y=i,c.nw=v.matrixTransform(d),v.x+=f,c.ne=v.matrixTransform(d),v.y+=g,c.se=v.matrixTransform(d),v.x-=f,c.sw=v.matrixTransform(d),v.y-=g/2,c.w=v.matrixTransform(d),v.x+=f,c.e=v.matrixTransform(d),v.x-=f/2,v.y-=g/2,c.n=v.matrixTransform(d),v.y+=g,c.s=v.matrixTransform(d),c}var q=c,r=d,s=e,t=n(),u=null,v=null,w=null;b.show=function(){var c=Array.prototype.slice.call(arguments);c[c.length-1]instanceof SVGElement&&(w=c.pop());var d,e=s.apply(this,c),f=r.apply(this,c),g=q.apply(this,c),h=a.select(t),i=y.length,j=document.documentElement.scrollTop||document.body.scrollTop,k=document.documentElement.scrollLeft||document.body.scrollLeft;for(h.html(e).style({opacity:1,"pointer-events":"all"});i--;)h.classed(y[i],!1);return d=x.get(g).apply(this),h.classed(g,!0).style({top:d.top+f[0]+j+"px",left:d.left+f[1]+k+"px"}),b},b.hide=function(){return nodel=a.select(t),nodel.style({opacity:0,"pointer-events":"none"}),b},b.attr=function(c){if(arguments.length<2&&"string"==typeof c)return a.select(t).attr(c);var d=Array.prototype.slice.call(arguments);return a.selection.prototype.attr.apply(a.select(t),d),b},b.style=function(c){if(arguments.length<2&&"string"==typeof c)return a.select(t).style(c);var d=Array.prototype.slice.call(arguments);return a.selection.prototype.style.apply(a.select(t),d),b},b.direction=function(c){return arguments.length?(q=null==c?c:a.functor(c),b):q},b.offset=function(c){return arguments.length?(r=null==c?c:a.functor(c),b):r},b.html=function(c){return arguments.length?(s=null==c?c:a.functor(c),b):s};var x=a.map({n:f,s:g,e:h,w:i,nw:j,ne:k,sw:l,se:m}),y=x.keys();return b}}),function(){function a(a){return a[0]}function b(a){return a[1]}function c(a,b,c){return"offset"==c?function(c){return"translate(0,"+(c+(0>c)-a)*b+")"}:function(c){return(0>c?"scale(1,-1)":"")+"translate(0,"+(c-a)*b+")"}}d3.horizon=function(){function f(a){a.each(function(a){var b,f,q,r,s=d3.select(this),t=1/0,u=-1/0,v=a.map(function(a,b){var c=j.call(this,a,b),d=k.call(this,a,b);return t>c&&(t=c),c>u&&(u=c),-d>l&&(l=-d),d>l&&(l=d),[c,d]}),w=d3.scale.linear().domain([t,u]).range([0,m]),x=d3.scale.linear().domain([0,l]).range([0,n*g]),y=c(g,n,h);this.__chart__?(b=this.__chart__.x,f=this.__chart__.y,q=this.__chart__.t,r=this.__chart__.id):(b=w.copy(),f=x.copy(),q=y,r=++e);var z=s.selectAll("defs").data([null]);z.enter().append("defs").append("clipPath").attr("id","d3_horizon_clip"+r).append("rect").attr("width",m).attr("height",n),z.select("rect").transition().duration(o).attr("width",m).attr("height",n),s.selectAll("g").data([null]).enter().append("g").attr("clip-path","url(#d3_horizon_clip"+r+")");var A=s.select("g").selectAll("path").data(d3.range(-1,-g-1,-1).concat(d3.range(1,g+1)),Number),B=d.interpolate(i).x(function(a){return b(a[0])}).y0(n*g).y1(function(a){return n*g-f(a[1])})(v),C=d.x(function(a){return w(a[0])}).y1(function(a){return n*g-x(a[1])})(v);A.enter().append("path").style("fill",p).attr("transform",q).attr("d",B),A.transition().duration(o).style("fill",p).attr("transform",y).attr("d",C),A.exit().transition().duration(o).attr("transform",y).attr("d",C).remove(),this.__chart__={x:w,y:x,t:y,id:r}}),d3.timer.flush()}var g=1,h="offset",i="linear",j=a,k=b,l=-1/0,m=960,n=40,o=0,p=d3.scale.linear().domain([-1,0,1]).range(["#d62728","#fff","#1f77b4"]);return f.duration=function(a){return arguments.length?(o=+a,f):o},f.bands=function(a){return arguments.length?(g=+a,p.domain([-g,0,g]),f):g},f.color=p,f.mode=function(a){return arguments.length?(h=a+"",f):h},f.colors=function(a){return arguments.length?(p.range(a),f):p.range()},f.interpolate=function(a){return arguments.length?(i=a+"",f):i},f.x=function(a){return arguments.length?(j=a,f):j},f.y=function(a){return arguments.length?(k=a,f):k},f.yMax=function(a){return arguments.length?(l=a,f):l},f.width=function(a){return arguments.length?(m=+a,f):m},f.height=function(a){return arguments.length?(n=+a,f):n},f};var d=d3.svg.area(),e=0}(),function(){"use strict";function a(a){i.push(a),a(g(),h())}function b(){var a=g(),b=h();i.forEach(function(c){c(Math.max(600,a),b)})}function c(a,b){a.each(function(){for(var a,c=d3.select(this),d=c.text().split(/\s+/).reverse(),e=[],f=0,g=1.1,h=c.attr("y")||0,i=c.attr("x")||0,j=parseFloat(c.attr("dy")||0),k=c.text(null).append("tspan").attr("x",i).attr("y",h).attr("dy",j+"em");a=d.pop();)e.push(a),k.text(e.join(" ")),(k.node().getComputedTextLength()>b||"<br>"===a)&&(e.pop(),k.text(e.join(" ")),e="<br>"!==a?[a]:[],k=c.append("tspan").attr("x",i).attr("y",h).attr("dy",++f*g+j+"em").text(a))})}function d(a,b){var c=d3.select("body").appendOnce("svg","svgdefs").attr("width",0).attr("height",0).appendOnce("defs","defs").appendOnce("linearGradient",b).firstTime.attr("id",b).attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("spreadMethod","pad"),d=d3.scale.linear().domain(d3.extent(a.domain())).range(["0%","100%"]);c.selectAll("stop").data(a.domain()).enter().append("svg:stop").attr("offset",d).attr("stop-color",a).attr("stop-opacity",1)}function e(a){return d3.select("body").appendOnce("svg","svgdefs").appendOnce("defs","defs").appendOnce("clipPath","clip-"+a).attr("id",a).appendOnce("rect","rect-"+a)}var f=/iPad|iPod|iPhone/.test(navigator.userAgent);d3.select("html").classed("ios",f);var g=f?function(){return document.body.clientWidth}:function(){return window.innerWidth||document.documentElement.clientWidth},h=f?function(){var a,b;switch(window.orientation||0){case 90:case-90:a=screen.height,b=screen.availWidth;break;default:a=screen.width,b=screen.availHeight}return b/a*document.body.clientWidth}:function(){return window.innerHeight||document.documentElement.clientHeight},i=[];d3.select(window).on("resize.watch",b).on("load.watch",b).on("orientationchange.watch",b).call(b),d3.select(window).on("scroll.d3-tip-hide",function(){d3.selectAll(".d3-tip").style("top","-50px")}),d3.selection.prototype.appendOnce=function(a,b){var c=this.selectAll("."+b.replace(/ /g,".")).data([1]);return c.firstTime=c.enter().append(a).attr("class",b),c},d3.selection.prototype.onOnce=function(a,b,c){return this.each(function(){$(this).on(a,b,function(a){var b=d3.select(this).datum();try{return d3.event=a.originalEvent,c.call(this,b)}finally{d3.event=null}})}),this},d3.selection.prototype.off=function(a){var b=this;return a.split(/\s+/g).forEach(function(a){b.each(function(){$(b).off(a)}).on(a,null)}),b},d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},window.VIZ={ios:f,watchSize:a,wrap:c,pageHeight:h,createColorScaleGradient:d,createClipRect:e,BREAK_SM:768,BREAK_MD:992,BREAK_LG:1200}}(),VIZ.fileSizes={"data/average-actual-delays.json":8084,"data/delay.json":2822327,"data/marey-header.json":1381,"data/marey-trips.json":818145,"data/spider.json":1928,"data/station-network.json":5389,"data/turnstile-gtfs-mapping.json":1439,"data/turnstile-heatmap.json":2787846},VIZ.fileHashes={"data/average-actual-delays.json":"f71ded52","data/delay.json":"84bbe7d5","data/marey-header.json":"b6bafbc1","data/marey-trips.json":"27ee0dfe","data/spider.json":"8b678242","data/station-network.json":"9511bc5d","data/turnstile-gtfs-mapping.json":"9b6de9ee","data/turnstile-heatmap.json":"efaee09d"},function(){"use strict";function a(a){var b=this;b.files=a,this.data={},b.progressListeners=[],b.doneListeners=[],b.errorListeners=[],b.amountLoaded={},a.forEach(function(a){if(a in b.amountLoaded)throw"duplicate file name "+a;b.amountLoaded[a]=0}),b.totalSize=a.reduce(function(a,b){var c=b.split("!")[1];if(!VIZ.fileSizes[c])throw"No size for "+c;return a+VIZ.fileSizes[c]},0),a.forEach(function(a){var c=a.split("!"),d=c[0],e=c[1];d3[d](e+"?nocache="+VIZ.fileHashes[e]).on("progress",function(){b.fileProgress(a,d3.event.loaded)}).get(function(c,d){c?(b.errorListeners.forEach(function(a){a(c)}),b.doneListeners=[],b.progressListeners=[]):(b.fileProgress(a,VIZ.fileSizes[e]),b.fileDone(a,d))})})}a.prototype.progress=function(a){return this.progressListeners.push(a),this},a.prototype.done=function(a){return this.doneListeners.push(a),this},a.prototype.onerror=function(a){return this.errorListeners.push(a),this},a.prototype.fileProgress=function(a,b){var c=this;this.amountLoaded[a]=b,this.progressListeners.forEach(function(a){a(Math.round(100*d3.sum(d3.values(c.amountLoaded))/c.totalSize))})},a.prototype.fileDone=function(a,b){var c=this;if(this.data[a]=b,d3.keys(this.data).length===this.files.length){var d=this.files.map(function(a){return c.data[a]});this.doneListeners.forEach(function(a){a.apply(c,d)})}},VIZ.requiresData=function(b){var c=new a(b);return c}}(),function(){function a(){j=s,showingMap=!1,v.style("margin-left",null),w.style("width",null),m=k,n=r,o=.9*k,t.forEach(b),u.forEach(c)}function b(a){a(m,n,h<VIZ.breakWidth)}function c(a){a(o)}function d(){showingMap=!0,j=i+k/3,v.style("margin-left",j+"px"),m=k/3-s,n=g,o=2*k/3,w.style("width",m+"px"),t.forEach(b),u.forEach(c)}function e(a,b){h=a,k=Math.max(Math.min(h,q),p)-2*s,i=.5*(h-k),g=b,clearTimeout(l),l=setTimeout(f,10)}function f(){h<=VIZ.breakWidth||VIZ.ios?a():d(),$(window).trigger("scroll")}VIZ.breakWidth=VIZ.BREAK_MD;{var g,h,i,j,k,l,m,n,o,p=768,q=1140,r=400,s=20,t=[],u=[],v=d3.selectAll(".fixed-container .fixed-right"),w=d3.selectAll(".fixed-container .fixed-left");$(".fixed-container .fixed-right"),$(".fixed-container .fixed-left")}VIZ.watchSize(e),f(),VIZ.watchFixedLeft=function(a){t.push(a),b(a),$(window).trigger("scroll")},VIZ.watchFixedRight=function(a){u.push(a),c(a),$(window).trigger("scroll")},d3.selectAll(".fixed-container").each(function(){function a(){h<VIZ.breakWidth||VIZ.ios?(f.style("top",null),f.style("left",null)):(b=g.offset().top+k,c=b-k+g.height()-j.height(),f.style("top",window.pageYOffset>c?c-window.pageYOffset+"px":window.pageYOffset<b?b-window.pageYOffset+"px":null),f.style("left",Math.round(i)+"px"))}var b,c,d=d3.select(this),e=d.select(".fixed-right"),f=d.select(".fixed-left"),g=$(e.node()),j=$(f.node()),k=+f.attr("data-top");VIZ.ios||(a(),$(window).on("scroll",a))})}(),function(){var a=($(".header .container"),$(".header .caption"),d3.select(".header .graphic").append("svg").attr("width",283).attr("height",283));VIZ.requiresData(["json!data/station-network.json","json!data/spider.json"]).done(function(b,c){"use strict";function d(a,b,c){var d=h[a.stop].pos,e=h[b.stop].pos,f=d3.interpolate(d,e)(c),g=Math.atan2(e[1]-d[1],e[0]-d[0])+Math.PI/2;return[f[0]+Math.cos(g)*j,f[1]+Math.sin(g)*j]}function e(b,c){var e=c?0:1e3/m;b||(b=n),n=b;var f=g.filter(function(a){return a.begin<b&&a.end>b}),h=f.map(function(a){for(var c=0;c<a.stops.length-1&&!(a.stops[c+1].time>b);c++);var e=a.stops[c],f=a.stops[c+1],g=(b-e.time)/(f.time-e.time);return{trip:a.trip,pos:d(e,f,g),line:a.line}}),i=a.select(".map-container").selectAll(".train").data(h,function(a){return a.trip});c?i.transition().duration(0).attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}):i.transition().duration(e).ease("linear").attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}),i.enter().append("circle").attr("class",function(a){return"train "+a.line}).attr("r",j).attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}),i.exit().remove(),b&&a.select(".time-display").text(function(){var a=moment(1e3*b);return a.format("dddd M/D h:mm a")})}function f(a,c,d){function f(a,b){r.selectAll("circle."+a).classed(b,!0).classed("end",!0).classed("middle",!1).attr("r",Math.max(q,3))}var h={top:20,right:30,bottom:10,left:10},i=d3.extent(b.nodes,function(a){return a.x}),j=d3.extent(b.nodes,function(a){return a.y}),k=c-h.left-h.right,l=d-h.top-h.bottom,m=k/(i[1]-i[0]),o=l/(j[1]-j[0]),p=Math.min(m,o);b.nodes.forEach(function(a){a.pos=[a.x*p,a.y*p]});var q=.2*p,r=a.attr("width",Math.max(250,p*(i[1]-i[0])+h.left+h.right)).attr("height",p*(j[1]-j[0])+h.top+h.bottom).appendOnce("g","map-container").attr("transform","translate("+h.left+","+h.top+")");r.appendOnce("text","time-display").attr("x",.55*a.attr("width")).attr("y",.55*a.attr("height"));var s=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){return a.name});r.call(s);var t=r.selectAll(".station").data(b.nodes,function(a){return a.name}),u=r.selectAll(".connect").data(b.links,function(a){return(a.source&&a.source.id)+"-"+(a.target&&a.target.id)});u.enter().append("line").attr("class",function(a){return"connect "+a.line}),u.attr("x1",function(a){return a.source.pos[0]}).attr("y1",function(a){return a.source.pos[1]}).attr("x2",function(a){return a.target.pos[0]}).attr("y2",function(a){return a.target.pos[1]}),t.enter().append("circle").attr("class",function(a){return"station middle station-label "+a.id}).on("mouseover",function(a){a.pos[1]<30?s.direction("e").offset([0,10]):s.direction("n").offset([-10,0]),s.show(a)}).on("mouseout",s.hide),t.attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}).attr("r",2),f("place-asmnl","red"),f("place-alfcl","red"),f("place-brntn","red"),f("place-wondl","blue"),f("place-bomnl","blue"),f("place-forhl","orange"),f("place-ogmnl","orange"),g&&e(n,!0)}var g,h={},i={};b.nodes.forEach(function(a){a.x=c[a.id][0],a.y=c[a.id][1],h[a.id]=a}),b.links.forEach(function(a){a.source=b.nodes[a.source],a.target=b.nodes[a.target],a.source.links=a.source.links||[],a.target.links=a.target.links||[],a.target.links.splice(0,0,a),a.source.links.splice(0,0,a),i[a.source.id+"|"+a.target.id]=a.line,i[a.target.id+"|"+a.source.id]=a.line}),VIZ.watchSize(function(){f(a,$(".container").width()/4,$(".container").width()/4)});var j=2,k=moment("2014/02/03 07:00 -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3,l=moment("2014/02/04 02:00 -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3,m=10;VIZ.requiresData(["json!data/marey-trips.json"]).progress(function(){}).onerror(function(){}).done(function(a){g=a,e(n,!0),function b(){e(n>l?k:n+60/m),setTimeout(b,1e3/m)}()});var n=k})}(),VIZ.requiresData(["json!data/station-network.json","json!data/spider.json","json!data/marey-trips.json","json!data/marey-header.json"]).progress(function(a){"use strict";d3.selectAll(".marey, .lined-up-marey").text("Loading train data... "+a+"%").style("text-align","center")}).onerror(function(){"use strict";d3.select(".marey, .lined-up-marey").text("Error loading train data").style("text-align","center")}).done(function(a,b,c,d){"use strict";function e(){w.classed("highlight-active",!!F),w.selectAll(".highlightable").classed("active",function(a){return a.trip===F})}function f(a){F=null==a?null:a.trip,e(),d3.event.stopPropagation()}function g(){G=null,j()}function h(a){G=a.trip,j()}function i(){var a=L.extent()[0]/1e3,b=L.extent()[1]/1e3;d3.selectAll(".lined-up .mareyline").style("opacity",function(c){return a<c.secs&&b>c.secs?.7:.1})}function j(){d3.selectAll(".hoverable").classed("hover",function(a){return a.trip===G})}function k(b,c,d){function e(a,b){o.selectAll("circle."+a).classed(b,!0).classed("end",!0).classed("middle",!1).attr("r",Math.max(n,3))}var f={top:30,right:30,bottom:10,left:10},g=d3.extent(a.nodes,function(a){return a.x}),h=d3.extent(a.nodes,function(a){return a.y}),i=c-f.left-f.right,j=Math.max(d-f.top-f.bottom-$(".side-caption").height()-40,150),k=i/(g[1]-g[0]),l=j/(h[1]-h[0]),m=Math.min(k,l);a.nodes.forEach(function(a){a.pos=[a.x*m,a.y*m]});var n=.2*m,o=b.attr("width",m*(g[1]-g[0])+f.left+f.right).attr("height",m*(h[1]-h[0])+f.top+f.bottom).appendOnce("g","map-container").attr("transform","translate("+f.left+","+f.top+")"),p=o.selectAll(".station").data(a.nodes,function(a){return a.name}),q=o.selectAll(".connect").data(a.links,function(a){return(a.source&&a.source.id)+"-"+(a.target&&a.target.id)});q.enter().append("line").attr("class",function(a){return"connect "+a.line+"-dimmable"}).attr("x1",function(a){return a.source.pos[0]}).attr("y1",function(a){return a.source.pos[1]}).attr("x2",function(a){return a.target.pos[0]}).attr("y2",function(a){return a.target.pos[1]}),q.attr("x1",function(a){return a.source.pos[0]}).attr("y1",function(a){return a.source.pos[1]}).attr("x2",function(a){return a.target.pos[0]}).attr("y2",function(a){return a.target.pos[1]}),p.enter().append("circle").attr("class",function(a){return"station middle station-label "+a.id}).on("mouseover",function(a){a.pos[1]<30?E.direction("e").offset([0,10]):E.direction("n").offset([-10,0]),E.show(a),M(a.id,_.unique(a.links.map(function(a){return a.line})))}).on("mouseout",function(a){E.hide(a),M(null)}).attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}).attr("r",3),p.attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}).attr("r",3),e("place-asmnl","red"),e("place-alfcl","red"),e("place-brntn","red"),e("place-wondl","blue"),e("place-bomnl","blue"),e("place-forhl","orange"),e("place-ogmnl","orange")}function l(a,b,c){var d=x[a.stop].pos,e=x[b.stop].pos,f=d3.interpolate(d,e)(c),g=Math.atan2(e[1]-d[1],e[0]-d[0])+Math.PI/2;return[f[0]+Math.cos(g)*z,f[1]+Math.sin(g)*z]}function m(a){if(a||(a=N),N=a,v){var b=c.filter(function(b){return b.begin<a&&b.end>a}),d=b.map(function(b){for(var c=0;c<b.stops.length-1&&!(b.stops[c+1].time>a);c++);var d=b.stops[c],e=b.stops[c+1],f=(a-d.time)/(e.time-d.time);return{trip:b.trip,pos:l(d,e,f),line:b.line}}),e=s.select(".map-container").selectAll(".train").data(d,function(a){return a.trip});e.enter().append("circle").attr("class",function(a){return"train highlightable hoverable dimmable "+a.line}).classed("active",function(a){return a.trip===F}).classed("hover",function(a){return a.trip===G}).attr("r",z).on("click",function(a){f(a)}).on("mouseover",h).on("mouseout",g),e.attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}),e.exit().remove(),u.text(moment(1e3*a).format("h:mm a"))}}function n(b,e){function j(a){a.attr("transform",function(a){return"translate("+S(a)+",-10)"})}function k(a,b,c,e){var f=null,g=c.stops.map(function(a){var b;return b=f&&"place-jfk"===f.stop&&"place-nqncy"===a.stop?[null,{stop:"place-asmnl",time:f.time},a]:f&&"place-nqncy"===f.stop&&"place-jfk"===a.stop?[{stop:"place-asmnl",time:a.time},null,a]:[a],f=a,b}),h=_.flatten(g),i=a(d[c.stops[0].stop+"|"+c.line][0]),j=h.map(function(f){if(!f)return null;var g=b(f.time)-b(h[0].time),j=a(d[f.stop+"|"+c.line][0]);return e&&(j-=i),[j,g]});return j}function l(a,b,c){return function(d){var e=k(a,b,d,c);return Nb(e)}}function n(a,b,c,d){var e=a.selectAll(".point").data(function(a){var d=k(b,c,a,!0).filter(function(a){return!!a}),e=S(a.stops[0].stop);return d.forEach(function(a){a.offset=e}),d},function(a,b){return b});e.enter().append("circle").attr("r",2).attr("class","point"),(d?e.transition().duration(o):e).attr("cx",function(a){return a.offset+a[0]}).attr("cy",function(a){return a[1]})}function r(a,b,c){var e=a.selectAll(".text").data(function(a){var e=b(d[a.stops[0].stop+"|"+a.line][0]),f=(T[A.stops[0].stop].anchor,a.stops.map(function(f){if(!f)return null;var g=c(f.time)-c(a.stops[0].time),h=b(d[f.stop+"|"+a.line][0])-e;return{stop:f,x:h,y:g,dytop:-1,dybottom:9}})),g=-10;return _.sortBy(f,"y").forEach(function(a){g+=9,g>a.y+a.dybottom&&(a.dybottom=g-a.y),g=a.y+a.dybottom}),g=1e3,_.sortBy(f,"y").reverse().forEach(function(a){g-=9,g<a.y+a.dytop&&(a.dytop=g-a.y),g=a.y+a.dytop}),f},function(a,b){return b}),f=e.enter().append("g").attr("class","text");f.append("text").attr("dx",function(){return"beginning"===T[A.stops[0].stop].anchor?2:-2}).attr("dy",function(a){return a.dytop}).text(function(a){return x[a.stop.stop].name.replace(/ station/i,"")}).attr("text-anchor",function(){return T[A.stops[0].stop].anchor}),f.append("text").attr("dx",function(){return"beginning"===T[A.stops[0].stop].anchor?-2:2}).attr("dy",function(a){return a.dybottom}).text(function(a){return moment(1e3*a.stop.time).format("h:mma")}).attr("text-anchor",function(){return"beginning"===T[A.stops[0].stop].anchor?"end":"beginning"}),e.attr("transform",function(a){var b=A.stops[0].stop,c=S(b);return"translate("+(a.x+c)+","+a.y+")"}).style("opacity",0),e.transition().delay(o-300).duration(300).style("opacity",1)}function s(a,b){a.oldDomain=a.oldDomain||a.domain(),a.domain(b)}function t(a,b){a.oldRange=a.oldRange||a.range(),a.range(b)}function v(a){a.oldDomain&&a.domain(a.oldDomain),a.oldRange&&a.range(a.oldRange),a.oldDomain=null,a.oldRange=null}function y(a,b,c){var e=c?0:o;if(A=A||a,v(db),v(cb),v(S),X=Y,q=b,A&&q){var f=1.1*(A.end-A.begin);s(db,[0,1e3*f]);var g=f/cb.domain()[1];s(cb,[0,f]);var h=A.stops[0],i=A.stops[A.stops.length-1],k=S(h.stop),l=k+Bb(d[i.stop+"|"+A.line][0])-Bb(d[h.stop+"|"+A.line][0]),m=T[h.stop].anchor,p=d3.scale.linear().domain([k,l]).range("beginning"===m?[50,qb-50]:[qb-50,50]);t(S,S.range().map(p)),X=1.5*Y/g,sb.selectAll(".mareyannotation").remove(),(c?Ab:Ab.transition().duration(e)).call(j).style("opacity",0)}else(c?Ab:Ab.transition().duration(e)).call(j).style("opacity",1);tb.selectAll(".mareynames").call(r,G,cb),zb.transition().duration(e).call(yb),tb.selectAll("g.mareystops").call(n,G,cb,!c),(c?Qb:Qb.transition().duration(e)).call(V),E()}function z(a){if(!q){E(),A=a;var b=(sb.appendOnce("text","mareyannotation"),a.stops[a.stops.length-1]),c=a.stops[0],d=ub(c.stop),e=S(c.stop),f=cb(b.time-c.time);sb.appendOnce("text","mareyannotation start").attr("x",e+("beginning"===T[c.stop].anchor?5:-5)).attr("y",-2).style("text-anchor",T[c.stop].anchor).text(moment(1e3*c.time).format("h:mma")),sb.appendOnce("text","mareyannotation clickme").attr("x",d).attr("y",16).style("text-anchor","middle").classed("light-markup",!0).text("Click for details"),sb.appendOnce("text","mareyannotation end").attr("x",d).attr("y",f+15).style("text-anchor","middle").text(moment(1e3*b.time).format("h:mma")),sb.appendOnce("text","mareyannotation time").attr("x",d).attr("y",f+30).style("text-anchor","middle").text(Math.round((b.time-c.time)/60)+"m"),tb.selectAll("g.mareystops").data([a]).enter().append("g").attr("class","mareystops").call(n,G,cb),tb.selectAll("g.mareynames").data([a]).enter().append("g").attr("class","mareynames"),sb.selectAll(".mareyline").classed({highlight:function(b){return b===a},dimmed:function(b){return b!==a}})}}function E(){A&&!q&&(A=null,sb.selectAll(".mareyannotation").remove(),tb.selectAll("*").remove(),sb.selectAll(".mareyline").classed({highlight:!1,dimmed:!1}))}function G(a){return X*Bb(a)*qb/jb}function V(a){a.attr("transform",function(a){var b=S(a.stops[0].stop);return"translate("+b+",0)"}).attr("d",l(G,cb,!0))}function W(){var a=d3.mouse(mb.node()),b=a[0],c=Gb[Math.round(Bb.invert(b))];c&&M(c)}function fb(){var a=d3.mouse(mb.node()),b=a[1],c=a[0];if(c>0&&jb>c){var d=Cb.invert(b);gb(d)}}function gb(a){var b=Cb(a);Ub.attr("transform","translate(0,"+b+")"),u.text(moment(1e3*a).format("h:mm a")),m(a)}if(e!==eb){eb=e,v(cb),v(S),v(db),X=Y,e=Math.round(e);var hb={top:100,right:200,bottom:0,left:60},ib=3500,jb=e-hb.left-hb.right,kb=ib-hb.top-hb.bottom;b.attr("width",e).attr("height",ib);var lb=b.appendOnce("g","header").attr("transform","translate("+hb.left+",0)"),mb=b.appendOnce("g","main").attr("transform","translate("+hb.left+", "+hb.top+")"),nb=mb.appendOnce("g","background"),mb=mb.appendOnce("g","foreground"),ob=b.appendOnce("g","annotations").attr("transform","translate("+hb.left+", "+hb.top+")"),pb=Math.min($(".lined-up-marey-container .container").width(),U),qb=pb-H.left-H.right;I=300*pb/780,J=I-H.top-H.bottom,K.range([0,J]),cb.range([0,J]);var rb=d3.select(".lined-up-marey").appendOnce("svg","lined-up").attr("width",pb).attr("height",I),sb=rb.appendOnce("g","g"),tb=rb.appendOnce("g","overlay");sb.firstTime.attr("transform","translate("+H.left+","+H.top+")"),tb.firstTime.attr("transform","translate("+H.left+","+H.top+")"),S.range(Z.map(function(a){return a*qb}));var ub=d3.scale.ordinal().domain(R).range(ab.map(function(a){return a*qb}));cb.range([0,J]),db.range([0,J]);var vb=d3.svg.axis().scale(K).tickFormat(d3.time.format.utc("%-I %p")).orient("left").ticks(d3.time.hour,2),wb=sb.appendOnce("g","time axis").attr("transform","translate(-40,0)").call(vb);wb.on("mousemove.brush",function(){var a=d3.mouse(wb.node())[1],b=K.invert(a);L.extent([b.getTime()-36e5,b.getTime()+36e5]),d3.selectAll("g.brush").call(L).on("mousedown.brush",null).on("touchstart.brush",null),i()}),wb.appendOnce("g","brush").firstTime.call(L).call(i).on("mousedown.brush",null).on("touchstart.brush",null).selectAll("rect").attr("x",-45).attr("width",50);var xb=d3.time.format("%-Mm"),yb=d3.svg.axis().tickFormat(function(a){return Math.round(a/1e3/60)+"m"}).innerTickSize(-qb).outerTickSize(0).ticks(d3.time.minutes,10).scale(db).orient("left"),zb=sb.appendOnce("g","y axis").call(yb);zb.appendOnce("text","label light-markup").attr("transform","rotate(90)translate("+J/2+",-5)").attr("text-anchor","middle").text("minutes since start of trip"),sb.appendOnce("text","top-label light-markup").text("Starting Station").attr("text-anchor","middle").attr("x",qb/2).attr("y",-24),sb.appendOnce("text","bottom-label light-markup").text("Ending Station").attr("text-anchor","middle").attr("x",qb/2).attr("y",J-5);var Ab=sb.selectAll(".station-header").data(R.filter(function(a){return T[a].text}));Ab.enter().append("g").attr("class","station-header").append("text").attr("text-anchor",function(a){return T[a].anchor}).attr("dx",function(a){return"beginning"===T[a].anchor?-4:4}).attr("dy",-2).text(function(a){return T[a].text}),Ab.call(j);var Bb=d3.scale.linear().domain(O).range([0,jb]),Cb=d3.scale.linear().domain([P,Q]).range([15,kb]).clamp(!0),Db=d3.time.scale().domain([new Date(1e3*P),new Date(1e3*Q)]).range([15,kb]),Eb=d3.keys(d),Fb=d3.scale.ordinal().domain(Eb).range(Eb.map(function(a){return Bb(d[a][0])})),Gb={};Eb.forEach(function(a){Gb[d[a][0]]=a});var Hb=lb.selectAll(".station-label").data(D).enter().append("text").attr("class","station-label").style("display",function(a){return C[a]?null:"none"}).style("text-anchor","beginning").text(function(a){return B[a].replace(/ station/i,"")});Hb.attr("transform",function(a){return"translate("+(Fb(a)-2)+","+(hb.top-3)+")rotate(-70)"});var Ib=ob.selectAll(".annotation").data(p);Ib.enter().append("g").attr("class","annotation").append("text").attr("id",function(a){return a.id}).text(function(a){return a.text}).call(VIZ.wrap,hb.right-20);var Jb=Ib.selectAll(".annotation-connection").data(function(a){return(a.connections||[]).map(function(b){return b.parent=a,b})});Jb.enter().append("path").attr("class","annotation-connection"),Jb.attr("d",function(b){var c=a.nodes.find(function(a){return new RegExp(b.station,"i").test(a.name)}),e=Cb(moment(b.parent.time+" -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3)-4,f=Cb(moment(b.start+" -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3),g=Cb(moment(b.stop+" -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3),h=Cb(moment(b.time+" -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3),i=Bb(d[c.id+"|"+b.line][0]);return"M"+[[[jb+10,e],[b.time?i:i+3,b.time?h:(f+g)/2]],b.time?null:[[i,f],[i+3,f],[i+3,g],[i,g]]].filter(function(a){return!!a}).map(function(a){return a.map(function(a){return a.map(Math.round).join(",")}).join("L")}).join("M")}),ob.selectAll("text, text tspan").attr("x",jb+15).attr("y",function(a){return Cb(moment(a.time+" -0500","YYYY/MM/DD HH:m ZZ").valueOf()/1e3)});var Kb=ob.selectAll("text tspan").filter(function(a){return a.link&&this.innerHTML.indexOf(a.link.text)>-1?this:null});Kb.each(function(a){var b=this.innerHTML;this.innerHTML=b.substring(0,b.indexOf(a.link.text));var c=b.substring(b.indexOf(a.link.text)+a.link.text.length,b.length),d=d3.select(this),e=d.node().getComputedTextLength(),g=!1,h=d.append("tspan").text(a.link.text).attr("xlink:href","#").attr("class","click-link").on("click",function(a){g=!g,f(g?{trip:a.link.trip}:null)}).on("mouseover",function(a){a.link.trip!==F&&g&&(g=!1),f({trip:a.link.trip}),j.attr("style","stroke-dasharray: 3,0")}).on("mouseout",function(){g||f(null),j.attr("style","stroke-dasharray: 3,3")});d.append("tspan").text(c);var i=this.parentNode.parentNode;console.log(i);var j=d3.select(i).append("polyline").attr("class","click-link").attr("points",function(){var a=e+parseInt(d.attr("x")),b=a+h.node().getComputedTextLength(),c=parseInt(d.attr("y"))+4,f=a+","+c;return f=f+" "+b+","+c})});var Lb=mb.selectAll(".station").data(D,function(a){return a});Lb.enter().append("line").attr("class",function(a){return"station "+a.replace("|","-")}),Lb.attr("x1",function(a){return Bb(d[a][0])}).attr("x2",function(a){return Bb(d[a][0])}).attr("y1",0).attr("y2",kb);var xb=d3.time.format("%-I:%M %p"),Mb=d3.svg.axis().tickFormat(xb).ticks(d3.time.minute,15).scale(Db).orient("left");mb.appendOnce("g","y axis").call(Mb);var Nb=d3.svg.line().x(function(a){return a[0]}).y(function(a){return a[1]}).defined(function(a){return null!==a}).interpolate("linear"),Ob=(d3.svg.area().x(function(a){return a[0]}).y(function(a){return a[1]}).defined(function(a){return null!==a}).interpolate("linear"),mb.selectAll(".mareyline").data(c,function(a){return a.trip})),Pb=sb.appendOnce("g","mareylinecontainer");Pb.firstTime.attr("clip-path","url(#mareyClip)"),sb.appendOnce("defs","defs").appendOnce("clipPath","clip").attr("id","mareyClip").appendOnce("rect","clipRect").attr("width",qb).attr("height",J);var Qb=Pb.selectAll(".mareyline").data(bb,function(a){return a.trip}),Rb=null;sb.off("mouseover mouseout").onOnce("mouseover","path",function(a){clearTimeout(Rb),z(a),d3.select(this).moveToFront()}).onOnce("mouseout","path",function(){clearTimeout(Rb),Rb=setTimeout(E,100)}),d3.selectAll(".lined-up-marey").on("click.toggle",function(){y(null,!q)}),y(A,q,!0),mb.firstTime.onOnce("mouseover","path.mareyline",h).onOnce("mouseout","path.mareyline",g).onOnce("click","path.mareyline",f),Ob.enter().append("path").attr("class",function(a){return"mareyline hoverable highlightable dimmable "+a.line}),Qb.enter().append("path").attr("class",function(a){return"mareyline "+a.line}),Ob.attr("transform",function(a){return a.origY||(a.origY=Cb(a.stops[0].time)),"translate(0,"+a.origY+")"}).attr("d",l(Bb,Cb)),Qb.call(V),w.select(".fixed-right").on("mousemove",fb),w.select(".fixed-right").on("mousemove.titles",W);var Sb=nb.appendOnce("g","g-bar hide-on-ios"),Tb=mb.appendOnce("g","g-bar hide-on-ios");Sb.appendOnce("line","bar").attr("x1",1).attr("x2",jb).attr("y1",0).attr("y2",0),Tb.appendOnce("rect","text-background").firstTime.attr("x",3).attr("y",-14).attr("width",45).attr("height",12),Tb.appendOnce("text","marey-time").firstTime.attr("dx",2).attr("dy",-4),u=w.selectAll(".marey-time");var Ub=w.selectAll("g.g-bar");N||gb(P)}}var o=1e3,p=[{time:"2014/02/03 05:00",text:"Service starts at 5AM on Monday morning. Each line represents the path of one train. Time continues downward, so steeper lines indicate slower trains. <br> ▾"},{time:"2014/02/03 05:55",text:'Since the red line splits, we show the Ashmont branch first then the Braintree branch.  Trains on the Braintree branch "jump over" the Ashmont branch.',connections:[{time:"2014/02/03 05:40",station:"ashmont",line:"red"}]},{time:"2014/02/03 06:30",text:"Train frequency increases around 6:30AM as morning rush hour begins.",id:"marey-morning-rush"},{time:"2014/02/03 11:30",text:"After the morning rush-hour subsides, everything runs smoothly throughout the middle of the day",id:"marey-midday-lull"},{time:"2014/02/03 15:30",text:"The afternoon rush hour begins around 3:30PM",id:"marey-evening-rush"},{time:"2014/02/03 17:00",text:"A disabled train causes delays on trains after (below) it for over an hour.  Notice how this causes delays in the other direction as well, as trains immediately arrive at Alewife then turn around to go south.",connections:[{start:"2014/02/03 17:02",stop:"2014/02/03 18:07",station:"JFK",line:"red"}],link:{text:"disabled train",trip:"R983382C2"}},{time:"2014/02/03 18:20",text:"Service to Bowdoin stops at 6:20PM",connections:[{time:"2014/02/03 18:20",station:"Bowdoin",line:"blue"}]},{time:"2014/02/03 19:00",text:"Normal service resumes for the evening starting around 7PM",id:"marey-evening-lull"},{time:"2014/02/03 20:50",text:"A disabled train at Wellington Station causes northbound delays on the Orange Line from 8:50PM to 9:15PM",connections:[{start:"2014/02/03 20:50",stop:"2014/02/03 21:15",station:"Community College",line:"orange"}],link:{text:"disabled train",trip:"O9861AEF3"}},{time:"2014/02/03 21:20",text:"Notice how southbound trains are temporarily delayed, but get back on schedule quickly."},{time:"2014/02/04 01:30",text:"The last trains of the night finish around 1:30AM"},{time:"2014/02/04 02:30",text:"At night, trains are moved between stations",connections:[{start:"2014/02/04 01:56",stop:"2014/02/04 02:03",station:"Orient Heights",line:"blue"},{start:"2014/02/04 03:59",stop:"2014/02/04 04:25",station:"JFK",line:"red"}]},{time:"2014/02/04 05:15",text:"At 5AM on Tuesday, the cycle begins again"}],q=!1,r=d3.select(".fixed-left"),s=r.select(".side-map").append("svg"),t=d3.select(".marey").text("").style("text-align","left").append("svg");
d3.select(".lined-up-marey").text("");var u,v,w=d3.select(".marey-container").classed("loading",!1),x={},y={},z=2.5,A=null;r.selectAll(".scrollto").on("click",function(){var a=d3.select(this).attr("data-dest"),b=$("#"+a),c=b.offsetParent().parent();(c.hasClass("fixed-right")?c:$("body")).animate({scrollTop:b.position().top},"300","swing"),d3.event.preventDefault()}),r.selectAll(".highlight").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=d3.select(this).attr("data-line"),b=_.without(["red","orange","blue"],a);b.forEach(function(a){w.selectAll("."+a+", ."+a+"-dimmable, circle.middle").classed("line-dimmed",!0)})}).on("mouseout",function(){w.selectAll(".line-dimmed").classed("line-dimmed",!1)}),a.nodes.forEach(function(a){a.x=b[a.id][0],a.y=b[a.id][1],x[a.id]=a}),a.links.forEach(function(b){b.source=a.nodes[b.source],b.target=a.nodes[b.target],b.source.links=b.source.links||[],b.target.links=b.target.links||[],b.target.links.splice(0,0,b),b.source.links.splice(0,0,b),y[b.source.id+"|"+b.target.id]=b.line,y[b.target.id+"|"+b.source.id]=b.line}),c.forEach(function(a){a.stops=a.stops||[];var b=moment(1e3*a.begin);a.secs=b.diff(b.clone().startOf("day"))/1e3});var B={},C={},D=a.nodes.map(function(a){return a.links.map(function(b){var c=a.id+"|"+b.line;return 1===a.links.length&&(C[c]=!0),B[c]=a.name,c})});D=_.unique(_.flatten(D));var E=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){return a.name});t.call(E);var F=null,G=null,H={top:50,right:40,bottom:30,left:80},I=400,J=I-H.top-H.bottom,K=d3.time.scale().domain([0,864e5]).range([0,J]).clamp(!0),L=d3.svg.brush().y(K).extent([252e5,324e5]).clamp(!0).on("brush",i);d3.select("body").on("click.highlightoff",function(){F=null,e()});var M=function(a,b){var c={};c[a]=!0,b?b.forEach(function(b){c[a+"|"+b]=!0}):a&&(c[a]=!0,c[a.replace(/\|.*/,"")]=!0);var d=t.selectAll("text.station-label");d.style("display",function(a){var b=C[a]||c[a];return b?null:"none"}),d.classed("active",function(a){return c[a.id?a.id:a]})},N=P,O=d3.extent(d3.values(d),function(a){return a[0]}),P=d3.min(d3.values(c),function(a){return a.begin}),Q=d3.max(d3.values(c),function(a){return a.end}),R=["place-alfcl","place-asmnl","place-brntn","place-wondl","place-gover","place-bomnl","place-ogmnl","place-forhl"],S=d3.scale.ordinal().domain(R),T={"place-alfcl":{text:"Alewife",anchor:"beginning"},"place-asmnl":{text:"Ashmont/Braintree",anchor:"end"},"place-brntn":{anchor:"end"},"place-wondl":{text:"Wonderland",anchor:"beginning"},"place-gover":{text:"Gov't Center",anchor:"end"},"place-bomnl":{anchor:"end"},"place-ogmnl":{text:"Orient Heights",anchor:"beginning"},"place-forhl":{text:"Forest Hills",anchor:"end"}},U=970,V=.02,W=.07,X=.52*(1-3*W-2*V),Y=X,Z=function(){var a=21,b=11,c=18,d=a+b+c,e=1-3*W-2*V,f=e*a/d/2,g=e*c/d/2;return[0,2*f+W,2*f+W,2*f+W+V,1-2*g-W-V,1-2*g-W-V,1-2*g-W,1]}(),ab=[d3.mean([Z[0],Z[1]]),d3.mean([Z[0],Z[1]]),d3.mean([Z[0],Z[1]]),d3.mean([Z[3],Z[4]]),d3.mean([Z[3],Z[4]]),d3.mean([Z[3],Z[4]]),d3.mean([Z[6],Z[7]]),d3.mean([Z[6],Z[7]])],bb=c.filter(function(a){return _.contains(R,a.stops[0].stop)}),cb=d3.scale.linear().domain([0,d3.max(bb,function(a){return a.stops[a.stops.length-1].time-a.stops[0].time})]),db=d3.time.scale().domain([0,d3.max(bb,function(a){return 1e3*(a.stops[a.stops.length-1].time-a.stops[0].time)})]);d3.selectAll(".lined-up-highlight").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=+d3.select(this).attr("data-lo"),b=+d3.select(this).attr("data-hi");L.extent([60*a*60*1e3,60*b*60*1e3]),d3.selectAll("g.brush").call(L).on("mousedown.brush",null).on("touchstart.brush",null),i()});var eb=null;VIZ.watchFixedRight(function(a){v=!0,n(t,a),m()}),k(s,300,800)}),VIZ.requiresData(["json!data/turnstile-heatmap.json","json!data/station-network.json","json!data/spider.json","json!data/turnstile-gtfs-mapping.json"]).progress(function(a){"use strict";d3.selectAll(".turnstile-all, .turnstile-total").text("Loading train data... "+a+"%").style("text-align","center")}).onerror(function(){"use strict";d3.selectAll(".turnstile-all, .turnstile-total").text("Error loading train data").style("text-align","center")}).done(function(a,b,c,d){"use strict";function e(){X.hide();var b=d3.selectAll(".section-people .turnstile-table svg"),c=b.selectAll(".row"),d=c.selectAll(".station-section").data(function(a){return W[a.name]?[a]:[]},function(a){return a.name}),e=d.enter().append("g").attr("class","station-section").attr("clip-path","url(#rowTurnstileClip)").attr("transform","translate(15,"+(7+kb.rangeBand())+")");e.append("g").each(function(b,c){d3.select(this).call(q,c,b.name,b,a)}),e.append("line").attr("class","border").attr("x1",-15).attr("x2",qb[1]+20-15).attr("y1",-3).attr("y2",-3),e.select(".stop-heatmap").append("g").attr("class","annotation details").attr("transform","translate(0,"+N+")").filter(function(a){return A[a.name]}).append("text").text(function(a){return A[a.name]}).call(VIZ.wrap,M).each(function(a){E[a.name]=d3.select(this).selectAll("tspan").size()});var h=0;a.stops.forEach(function(a){var b=a.name;D[b]=h,W[b]&&(h+=N+12*(E[b]||0)+5)});var i=d.exit().attr("class",".old-station-section").call(function(a){E[a.name]=0});e.call(g),setTimeout(function(){e.transition().call(f),i.transition().call(g).remove(),c.transition().each("end",function(){$(window).trigger("scroll")}).call(k),b.transition().attr("height",fb+h),l()})}function f(a){a.selectAll(".stop-heatmap").attr("transform","translate(0,0)")}function g(a){a.selectAll(".stop-heatmap").attr("transform",function(a){return"translate(0,"+(-N-12*(E[a.name]||0))+")"})}function h(a,b,c,d){var e={top:10,right:30,bottom:10,left:10},f=300-e.left-e.right,g=d3.selectAll(".section-people .turnstile-viz .key.circles").appendOnce("svg","key-container").attr("width",300).attr("height",50).appendOnce("g","key-g").attr("transform","translate("+e.left+","+e.top+")"),h=g.appendOnce("text","middle-text").attr("x",f/2).attr("y",5).attr("text-anchor","middle");h.text("Size shows turnstile "+(c||"")).call(VIZ.wrap,250);var i=d3.scale.ordinal().domain(a).range([30,75,135]),j=g.selectAll("circle").data(a);j.enter().append("circle").attr("class","station middle"),j.attr("r",function(a){return b(a)}).attr("cx",function(a){return i(a)-b(a)-2}).attr("cy",30),j.exit().remove();var k=g.selectAll("text.num").data(a);k.enter().append("text").attr("class","num"),k.text(d3.format(",.0f")).attr("x",function(a){return i(a)}).attr("y",35),k.exit().remove(),g.appendOnce("text","ppl").attr("text-anchor","beginning").attr("x",i(_.last(a))+37).attr("y",35).text("people "+d)}function i(){h([500,1e4,19400],G,"entries on average day","per day"),d3.selectAll(".section-people .glyph circle").attr("r",function(a){return G(C[a.id])})}function j(a){function c(a,b){l.selectAll("circle."+a).classed(b,!0).classed("end",!0).classed("middle",!1)}var d={top:20,right:30,bottom:10,left:10},e=d3.extent(b.nodes,function(a){return a.x}),f=d3.extent(b.nodes,function(a){return a.y}),g=300-d.left-d.right,h=300-d.top-d.bottom,i=g/(e[1]-e[0]),j=h/(f[1]-f[0]),k=Math.min(i,j);b.nodes.forEach(function(a){a.pos=[a.x*k,a.y*k]});var l=a.attr("width",k*(e[1]-e[0])+d.left+d.right).attr("height",k*(f[1]-f[0])+d.top+d.bottom).appendOnce("g","map-container").attr("transform","translate("+d.left+","+d.top+")");l.appendOnce("text","time-display").attr("x",.55*a.attr("width")).attr("y",.55*a.attr("height"));var m=d3.tip().attr("class","d3-tip text-center").offset([-10,0]).html(function(a){return a.name+"<br>Average "+d3.format(",.0f")(d3.round(C[a.id],-2))+" entrances per day"});l.call(m);var p=l.selectAll(".station").data(b.nodes,function(a){return a.name}),q=l.selectAll(".connect").data(b.links,function(a){return(a.source&&a.source.id)+"-"+(a.target&&a.target.id)});q.enter().append("line").attr("class",function(a){return"connect "+a.line}),q.attr("x1",function(a){return a.source.pos[0]}).attr("y1",function(a){return a.source.pos[1]}).attr("x2",function(a){return a.target.pos[0]}).attr("y2",function(a){return a.target.pos[1]}),p.enter().append("circle").attr("class",function(a){return"station middle dimmable station-label "+a.id}).on("mouseover",function(a){a.pos[1]<30?m.direction("e").offset([0,10]):m.direction("n").offset([-10,0]),m.show(a),n(a.id)}).style("cursor","pointer").on("mouseout.tip",m.hide).on("mouseout.station",o).on("click",function(a){var b=$(".row."+a.id),c=b.offsetParent().parent();if(c.hasClass("fixed-right"))c.animate({scrollTop:b.position().top},"300","swing");else{var d=b.position().top,e=$("body").scrollTop(),f=e+VIZ.pageHeight();e>d-20?$("body").animate({scrollTop:d-20},"300","swing"):d+30>f&&$("body").animate({scrollTop:d+30-VIZ.pageHeight()},"300","swing")}d3.event.preventDefault()}),p.attr("cx",function(a){return a.pos[0]}).attr("cy",function(a){return a.pos[1]}).attr("r",function(a){return G(C[a.id])}),c("place-asmnl","red"),c("place-alfcl","red"),c("place-brntn","red"),c("place-wondl","blue"),c("place-bomnl","blue"),c("place-forhl","orange"),c("place-ogmnl","orange")}function k(a){a.attr("transform",function(a){return"translate(0,"+(kb(a.name)+(D[a.name]||0))+")"})}function l(){sb.attr("width",function(a){return W[a.name]?eb:qb[0]+rb(a.entrancesByType.all)+pb}).attr("height",function(a){var b=a.name,c=kb.rangeBand()/.7;return W[b]&&(c+=N+12*(E[b]||0)+5),c})}function m(a){function b(a){var b=C[a.id||d[a.name]];return h>=b&&b>=g}var c=d[a.name];if(z){var e=a.entrancesByType.all,f=z.entrancesByType.all,g=d3.min([e,f]),h=d3.max([e,f]),i=d3.select(".section-people .turnstile-viz");i.selectAll(".glyph").classed("highlighting",!0),i.selectAll("[class*=place-]").classed("active",b)}else n(c,!0)}function n(a,b){var c=d3.select(".section-people .turnstile-viz");c.selectAll(b?".glyph":".turnstile-table").classed("highlighting",!0),c.selectAll("."+a).classed("active",!0)}function o(){var a=d3.selectAll(".section-people .turnstile-viz .glyph, .section-people .turnstile-viz .turnstile-table");a.classed("highlighting",!1),a.selectAll(".active").classed("active",!1)}function p(a){var b=a%12===0?12:a%12;return b+=a>=12?"pm":"am"}function q(b,c,e,f,g,j){var k=["Sun","Mon","Tues","Wed","Thurs","Fri","Sat"],l=7*(L+R.right),m=(l+Q.left+Q.right,b.append("g").attr("class","stop-heatmap")),n=m.selectAll(".dayLabel").data(k).enter().append("g").attr("class","xAxis");j&&n.append("text").attr("class","dayLabel").text(function(a){return a}).attr("dx",function(){return L/2}).attr("dy",0).style("text-anchor","middle");var o=d3.scale.ordinal().domain(["6am","12pm","6pm"]).rangePoints([0,L],2),q=d3.svg.axis().scale(o).orient("bottom").tickSize(-3);n.attr("transform",function(a,b){return"translate("+(3+Q.left+(L+R.right)*b)+",0)"}).call(q);var r=m.append("g").attr("transform","translate("+Q.left+","+Q.top+")"),v=d3.scale.linear().domain([g.min,g.mean||.9*g.max,g.max]).range(["white","black","red"]),w=d3.scale.ordinal().rangeBands([0,L],0,0).domain(d3.range(0,24));["entrances","exits"].forEach(function(a,b){r.selectAll("."+a).data(f.times.filter(function(a){return!!a})).enter().append("rect").attr("class",function(b){return"highlight-dimmable "+a+" "+x(b)}).attr("x",function(a){return(L+R.right)*t(a)+w(s(a))}).attr("y",function(a){return(K+R.bottom)*(u(a)+5*b)}).attr("width",J).attr("height",K).attr("fill",function(b){return v(b[a])})}),r.append("text").attr("x",0).attr("dy",-3).attr("text-anchor","end").attr("class","weeklabel light-markup small").text("Week"),r.selectAll(".grp").data([0,1]).enter().append("g").attr("class","grp").attr("transform",function(a){return"translate(0,"+5*(K+R.bottom)*a+")"}).selectAll(".weeklabel").data([0,1,2,3]).enter().append("text").attr("class","weeklabel light-markup small").attr("x",-3).attr("dy",6).attr("text-anchor","end").attr("y",function(a){return(K+R.bottom)*a}).text(function(a){return a+1}),m.append("text").attr("class","groupLabel light-markup small").attr("transform","translate("+(M-10)+","+3.5*K+")rotate(90)").text("entrances").style("text-anchor","middle"),m.append("text").attr("class","groupLabel light-markup small").attr("transform","translate("+(M-10)+","+10*K+")rotate(90)").text("exits").style("text-anchor","middle"),m.onOnce("mouseover","rect",function(b){if(clearTimeout(F),m.selectAll("rect").classed("hover",function(a){return b.day===a.day&&b.week===a.week&&b.hour===a.hour}),X.direction("w").offset([-3,-12]),X.show.call(this,b),!j){var c={},e=p(b.hour%24),f=p((b.hour+1)%24),g=d3.select(this).classed("entrances")?"entrances":"exits";a.stops.forEach(function(a){var e=a.times[b.i];c[d[a.name]]=e?e[g]:0}),d3.selectAll(".section-people .glyph circle").attr("r",function(a){return H(c[a.id])});var i=moment(b.time).format("ddd MMM D");h([0,40,82],I,g+" on "+i+" from "+e+" to "+f,"per minute")}}).onOnce("mouseout","rect",function(a){m.selectAll("rect").classed("hover",!1),X.direction("n").offset([-10,0]),X.hide.call(this,a),clearTimeout(F),F=setTimeout(i,O)})}function r(a,b,c,d){var e=150,f=M,g=(f-500)/2,h=70,i={top:25,right:g,bottom:0,left:Q.left},j=(f-i.left-i.right,f-i.top-i.bottom,d3.scale.linear().domain(c).range(["white","black","red"])),k=d3.selectAll(a),l=k.append("svg").attr("width",f).attr("height",h).append("g").attr("transform","translate("+i.left+","+i.top+")"),m=l.append("text").attr("y",10).text("Color shows average entrances/exits"),n=m.node().getComputedTextLength()+10,o=d3.scale.linear().domain(d3.extent(j.domain()).map(function(a){return a/60})).range([0,e]);VIZ.createColorScaleGradient(j,b);var p=l.append("g").attr("transform","translate("+n+",1)"),q=(p.append("rect").attr("width",e).attr("height",K).attr("fill","url(#"+b+")"),d3.svg.axis().scale(o).orient("bottom").tickValues(d).tickFormat(d3.format(".0f")).tickSize(4));p.append("g").attr("class","x axis").attr("transform",function(){return"translate(0,"+K+")"}).call(q).append("text").attr("text-anchor","beginning").attr("x",e+14).attr("dy",14).text("people per minute")}function s(a){return a.hour}function t(a){return a.day}function u(a){return a.week-1}function v(a,b){return 2===a&&1===b}function w(a,b){return 0===b||6===b}function x(a){var b=u(a),c=t(a);return v(b,c)||w(b,c)?"offpeak":"weekday"}function y(a,b){return moment(a.time).format("ddd MMM D [from] ha")+" to "+moment(a.time).add(1,"hour").format("ha")+"<br>"+d3.format(",.0f")(a[b]/60)+" "+b+" per minute"}var z,A={"Suffolk Downs":"Suffolk Downs is the least-busy station and experiences very little traffic throughout the day.  It is one of the few stations with no bus connections.","North Station":"North Stations experiences a lot of traffic spikes in the evening, since it is right by the TD Garden Arena, home of the Celtics and Bruins",Harvard:"As the original end of the Red Line, Harvard is the busiest station and has a constant stream of people getting on and off throughout the day.  The adjoining Harvard Bus Tunnel also has connections to five of the fifteen busiest MBTA bus routes.","South Station":"In the heart of Boston's Financial District, South Station is a destination for people to go to work, but it is also at the end of the commuter rail and people who take that into the city must go through a turnstile after getting off the commuter rail to get to other parts of the city","Downtown Crossing":"Like South Station, Downtown Crossing is primarily a work destination, but it does not experience the commuter-rail bump in entrances in the morning"},B=d3.behavior.drag().origin(function(a){return a}).on("dragstart",function(a){z=a}).on("dragend",function(){z=null});d3.selectAll(".turnstile-all, .turnstile-total").text("");var C={},D={},E={};a.stops.forEach(function(a){C[d[a.name]]=a.entrancesByType.all});var F,G=d3.scale.linear().domain(d3.extent(d3.values(C))).range([2,7]),H=d3.scale.sqrt().domain([0,a.max]).range([2,7]),I=d3.scale.sqrt().domain([0,a.max/60]).range([2,7]),J=3,K=8,L=24*J,M=7.5*L+15,N=9*K+40,O=100,P={top:15,right:0,bottom:0,left:0},Q={top:10,right:0,bottom:0,left:25},R={top:0,right:2,bottom:2,left:0};VIZ.createClipRect("rowTurnstileClip").attr("y",-3).attr("x",-20).attr("width",M+40).attr("height",2*N);var S=d3.select(".turnstile-total").append("svg"),T=S.append("g"),U=d3.scale.linear().clamp(!0).domain([0,VIZ.BREAK_SM,VIZ.BREAK_SM,VIZ.BREAK_MD,VIZ.BREAK_MD,VIZ.BREAK_LG,VIZ.BREAK_LG,VIZ.BREAK_LG+1]).range([1.1,1.1,1.2,1.2,1.2,1.2,1.3,1.3]);S.attr("width",M).attr("height",N);var V=(d3.select(".turnstile-all"),T.append("g","outer-g-container").attr("transform","translate("+P.left+","+P.top+")").call(q,0,"All Stations",a.all,a.all,!0));VIZ.watchSize(function(a){var b=U(a);S.attr("width",M*b).attr("height",N*b),T.attr("transform","scale("+b+")")});var W={},X=d3.tip().attr("class","d3-tip text-center").offset([-10,0]).html(function(a){return y(a,d3.select(this).classed("entrances")?"entrances":"exits")});V.call(X);var Y={holidays:[[3,1]],snow:[[1,3],[2,4]]},Z=T.selectAll(".highlight-group").data([2,7]).enter().append("g").attr("class",function(a){return"highlight-group num"+a}).attr("transform",function(a){return"translate("+(Q.left+15)+","+(a*(R.bottom+K)-6)+")"});d3.selectAll(".section-people .highlight-total").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=d3.select(this).attr("data-highlight"),b=Y[a];Z.selectAll("rect.highlight").data(b).enter().append("rect").attr("class","highlight").attr("width",L-7).attr("height",K+2).attr("x",function(a){return(L+R.right)*a[1]}).attr("y",function(a){return(K+R.bottom)*a[0]}),T.selectAll(".num2").selectAll("line.highlight").data(b).enter().append("line").attr("class","highlight").attr("x1",function(a){return(L+R.right)*a[1]}).attr("x2",function(a){return(L+R.right)*a[1]}).attr("y1",function(a){return(K+R.bottom)*a[0]}).attr("y2",function(a){return(K+R.bottom)*a[0]+5*(R.bottom+K)})}).on("mouseout",function(){T.selectAll(".highlight").remove()}),d3.selectAll(".section-people .dim").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=d3.select(this).attr("data-dim");T.selectAll("."+a).style("opacity",.1)}).on("mouseout",function(){var a=d3.select(this).attr("data-dim");T.selectAll("."+a).style("opacity",1)});var ab={},bb={},cb={};b.nodes.forEach(function(a){a.x=c[a.id][0],a.y=c[a.id][1],ab[a.id]=a}),b.links.forEach(function(a){a.source=b.nodes[a.source],a.target=b.nodes[a.target],a.source.links=a.source.links||[],a.target.links=a.target.links||[],a.target.links.splice(0,0,a),a.source.links.splice(0,0,a),bb[a.source.id+"|"+a.target.id]=a.line,bb[a.target.id+"|"+a.source.id]=a.line,cb[a.target.id]=cb[a.target.id]||{},cb[a.source.id]=cb[a.source.id]||{},cb[a.target.id][a.line]=!0,cb[a.source.id][a.line]=!0});var V=d3.select(".section-people .glyph").append("svg").call(j);VIZ.watchFixedLeft(function(a,b){d3.select(".section-people .fixed-left").style("margin-left",b?null:a-300+"px")}),i();var db={top:20,right:20,bottom:10,left:10},eb=580,fb=800,gb=fb-db.top-db.bottom,hb=eb-db.left-db.right,ib=d3.select(".section-people .turnstile-table").append("svg").attr("class","barchart").attr("width",eb).attr("height",fb).append("g").attr("transform","translate("+db.left+","+db.top+")"),jb=d3.tip().attr("class","d3-tip text-center").offset([-10,0]);ib.call(jb);var kb=d3.scale.ordinal().domain(a.stops.map(function(a){return a.name})).rangeRoundBands([0,gb],.3),lb=ib.selectAll(".row").data(a.stops).enter().append("g").attr("class",function(a){return d[a.name]+" row dimmable"}).call(B).call(k),mb=15,nb=120,ob=nb+L+5,pb=35,qb=[ob+L+5,hb],rb=d3.scale.linear().domain([0,d3.max(a.stops,function(a){return a.entrancesByType.all})]).range([0,qb[1]-qb[0]-15]),sb=lb.append("rect").style("fill","white").attr("class","bounding-box");d3.selectAll(".section-people .highlight").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=d3.select(this).attr("data-highlight"),b=d3.select(".section-people .turnstile-table");b.selectAll(".highlight-dimmable").classed({dim:function(){return!d3.select(this).classed(a)},active:function(){return d3.select(this).classed(a)}})}).on("mouseout",function(){var a=d3.select(".section-people .turnstile-table");a.selectAll(".dim").classed({dim:!1,active:!1})}),d3.selectAll(".section-people .highlight-stops").on("click",function(){d3.event.preventDefault();var a=d3.select(this).attr("data-stops").split(","),b=!0;a.forEach(function(a){b=b&&W[a]}),b=b&&Object.keys(W).filter(function(a){return W[a]}).length===a.length,W={},b||a.forEach(function(a){W[a]=!0}),e()}).on("mouseover",function(){var a=d3.select(this).attr("data-stops").split(",").map(function(a){return"."+d[a]}).join(", "),b=d3.select(".section-people .turnstile-viz").selectAll(".glyph, .turnstile-table");b.classed("highlighting",!0),b.selectAll(a).classed("active",!0)}).on("mouseout",o),lb.on("mouseover",m).on("mouseout",o).on("click",function(a){W[a.name]=!W[a.name],e(a.name)}),lb.append("text").attr("x",mb).attr("y",kb.rangeBand()).attr("class","highlight-dimmable").text(function(a){return a.name}).append("title").text("Click to show details below");var tb=lb.selectAll(".heatmaps").data(function(a){return[{parent:a,type:"entrances",day:"offpeak",x:ob,y:0},{parent:a,type:"exits",day:"offpeak",x:ob,y:kb.rangeBand()/2},{parent:a,type:"entrances",day:"weekday",x:nb,y:0},{parent:a,type:"exits",day:"weekday",x:nb,y:kb.rangeBand()/2}]}).enter().append("g").attr("class",function(a){return"heatmap highlight-dimmable "+a.type+" "+a.day}).attr("transform",function(a){return"translate("+a.x+","+a.y+")"});lb.append("rect").attr("class","outline").attr("x",ob).attr("y",0).attr("width",24*J).attr("height",kb.rangeBand()),lb.append("rect").attr("class","outline").attr("x",nb).attr("y",0).attr("width",24*J).attr("height",kb.rangeBand()),ib.selectAll(".dayLabel").data([["Station","beginning",mb],["Avg. Weekday","middle",nb+L/2],["Avg. Weekend","middle",ob+L/2],["Avg. Turnstile Entries per day","beginning",qb[0]]]).enter().append("g").attr("class","xAxis").append("text").attr("class","dayLabel").attr("x",function(a){return a[2]}).attr("y",function(a){return a[3]||-10}).text(function(a){return a[0]}).style("text-anchor",function(a){return a[1]}),ib.append("line").attr("class","border").attr("x1",0).attr("x2",qb[1]+20).attr("y1",-7).attr("y2",-7);var ub=ib.selectAll(".hours").data([nb,ob]).enter().append("g").attr("class","hours xAxis"),vb=d3.scale.ordinal().domain(["6am","12pm","6pm"]).rangePoints([0,L],2),wb=d3.svg.axis().scale(vb).orient("bottom");ub.attr("transform",function(a){return"translate("+a+",-11)"}).call(wb);var xb=d3.scale.ordinal().rangeBands([0,L],0,0).domain(d3.range(0,24)),yb=d3.scale.linear().domain([a.min,a.mean||.9*a.max,a.max]).range(["white","black","red"]);tb.selectAll("rect").data(function(a){return a.parent.averagesByType[a.day].filter(function(a){return!!a}).map(function(b){return{hour:b.hour,datum:b[a.type],name:a.parent.name,day:a.day,type:a.type}})}).enter().append("rect").attr("x",function(a){return xb(a.hour)}).attr("width",J).attr("height",kb.rangeBand()/2).attr("fill",function(a){return yb(a.datum)}),ib.onOnce("mouseover",".heatmap rect",function(b){clearTimeout(F);var c=p(b.hour),e=p((b.hour+1)%24),f=(b.name,d[b.name]);ib.selectAll(".row."+f).select(".stop-heatmap").selectAll("rect."+b.type).classed("hover",function(a){return x(a)===b.day&&a.hour===b.hour}),jb.html(b.name+" from "+c+" to "+e+" on average "+("weekday"===b.day?"weekday":"weekend/holiday")+"<br>"+d3.format(".0f")(b.datum/60)+" "+b.type+" per minute"),jb.show(b);var g={};a.stops.forEach(function(a){var c=a.averagesByType[b.day][b.hour];g[d[a.name]]=c?c[b.type]:0}),d3.selectAll(".section-people .glyph circle").attr("r",function(a){return H(g[a.id])}),h([0,40,82],I,b.type+" on "+("weekday"===b.day?"weekdays":"weekends/holidays")+" from "+c+" to "+e,"per minute")}).onOnce("mouseout",".heatmap rect",function(a){var b=(a.name,d[a.name]);ib.selectAll(".row."+b).select(".stop-heatmap").selectAll("rect").classed("hover",!1),jb.hide(a),clearTimeout(F),F=setTimeout(i,O)}),lb.append("rect").attr("class","bar highlight-dimmable").attr("x",qb[0]).attr("width",function(a){return rb(a.entrancesByType.all)}).attr("height",kb.rangeBand()+1),lb.append("text").attr("x",function(a){return qb[0]+rb(a.entrancesByType.all)}).attr("text-anchor","beginning").attr("dx",2).attr("dy",kb.rangeBand()).attr("class","highlight-dimmable").text(function(a){var b=a.entrancesByType.all,c=Math.ceil(Math.log10(b/100));return d3.format(",."+c+"r")(b)});var zb=["red","blue","orange"],Ab=d3.scale.ordinal().domain([1,0]).rangePoints([0,10]);lb.selectAll(".line").data(function(a){return zb.filter(function(b){return cb[d[a.name]][b]})}).enter().append("circle").attr("r",3).attr("cx",function(a,b){return Ab(b)}).attr("cy",kb.rangeBand()-5).attr("class",function(a){return"highlight-dimmable line "+a}).on("mouseover",function(a){jb.html(a+" line"),jb.show(a)}).on("mouseout",jb.hide),r(".turnstile.key","turnstileGradient",[0,.9*a.all.max,a.all.max],[0,200,400,600,d3.round(a.all.max/60,0)]),r(".turnstile-all-key.key","turnstileAllGradient",[0,a.mean,a.max],[0,20,40,60,d3.round(a.max/60,0)]),e();{var Bb=d3.time.format("%Y-%m-%d %H:%M:%S");Bb.parse("2014-01-26 00:00:00"),d3.time.format("%b %d, %H:%M")}}),VIZ.requiresData(["json!data/delay.json","json!data/station-network.json","json!data/spider.json","json!data/average-actual-delays.json"]).progress(function(a){"use strict";d3.selectAll(".interaction-all .loading").text("Loading delay data... "+a+"%").style("text-align","center")}).onerror(function(){"use strict";d3.select(".interaction-all .loading").text("Error loading delay data").style("text-align","center")}).done(function(a,b,c,d){"use strict";function e(a){var b,c=G[a.ids];return b=null===c||"undefined"==typeof c?"white":jb(c)}function f(){var a=d3.mouse(N.node())[0]-u.left,b=d3.mouse(N.node())[1];if(!(0>b||0>a||b>C||a>D)){var c=Math.max(1,d3.bisectLeft(P.range(),b))%7,d=Y.invert(a).getTime();g(c,d)}}function g(a,c){function f(a,b){var c=a+"|"+b;if(r.hasOwnProperty(c)){var e=r[c],f=d[c],g=f/e;G[c]=g}}var g=Y(c),h=P(a);mb.attr("transform","translate("+(g+u.left)+","+h+")"),nb.text(moment(c).utc().format("h:mm a"));var i=moment(c).utc().format("h:mm a")+" on "+moment.weekdaysShort()[a]+" Feb "+(a?a+2:9);M.text(i),d3.select(".interaction-all .time").text(i);var j=bb[a];G={};var k=qb(j,c/1e3)-1,l=(c-1)%rb/rb,m=j[k]||j[k+1],n=j[k+1]||m;H=d3.interpolate(m.ins,n.ins)(l),ob.text(d3.format("0f")(d3.interpolate(m.ins_total,n.ins_total)(l))+" entries/min");var o=d3.interpolate(m.delay_actual,n.delay_actual)(l);pb.text(0>o?d3.format("%")(-o)+" fast":d3.format("%")(o)+" slow");var p=_.extend.apply(null,[{}].concat(_.pluck(m.lines,"delay_actual"))),q=_.extend.apply(null,[{}].concat(_.pluck(n.lines,"delay_actual"))),r=d3.interpolate(p,q)(l);b.links.forEach(function(a){f(a.source.id,a.target.id),f(a.target.id,a.source.id)}),L.selectAll(".connect path").attr("fill",e).attr("d",t)}function h(a,b){return a.links.map(function(c){var d,e;return c.target===a?(d=[c.source.pos,c.target.pos],e=c.source.id+"|"+c.target.id):(d=[c.target.pos,c.source.pos],e=c.target.id+"|"+c.source.id),{segment:d,line:c.line,ids:e,day:b}})}function i(a,b){return a.links.map(function(c){var d,e;return c.source===a?(d=[c.source.pos,c.target.pos],e=c.source.id+"|"+c.target.id):(d=[c.target.pos,c.source.pos],e=c.target.id+"|"+c.source.id),{segment:d,line:c.line,ids:e,day:b}})}function j(a,b){L.append("circle").attr("cx",hb*c[a][0]).attr("cy",hb*c[a][1]).attr("fill",b).attr("r",kb).attr("stroke","none")}function k(a,b){var c=o(a.segment);b=b||[];var d=null,e=1/0;return b.forEach(function(b){if(!m(b,a)){var f=o(b.segment)+Math.PI,g=-n(f-c);e>g&&(e=g,d=b)}}),d}function l(a,b){var c=o(a.segment);b=b||[];var d=null,e=1/0;return b.forEach(function(a){var b=o(a.segment),f=n(c-b),g=Math.abs(f);.2>g||Math.abs(g-Math.PI)<.2||e>f&&(e=f,d=a)}),d}function m(a,b){var c=JSON.stringify(a.segment),d=JSON.stringify(b.segment);return c===d}function n(a){return(4*Math.PI+a)%(2*Math.PI)-Math.PI}function o(a,b){if(1===arguments.length){var c=a;a=c[0],b=c[1]}return Math.atan2(b[1]-a[1],b[0]-a[0])}function p(a){var b=a.ids.split("|").map(function(a){var b=H[a];return ib(b||0)}),c=a.segment[0],d=a.segment[1],e=o(c,d),f=e+Math.PI/2,g=[d[0]+b[1]*Math.cos(f),d[1]+b[1]*Math.sin(f)],h=[c[0]+b[0]*Math.cos(f),c[1]+b[0]*Math.sin(f)];return[h,g]}function q(a){return(a[1][1]-a[0][1])/(a[1][0]-a[0][0])}function r(a){return a[1][1]-q(a)*a[1][0]}function s(a,b){var c,d,e=q(a),f=r(a),g=q(b),h=r(b),i=1/0===e||e===-1/0,j=1/0===g||g===-1/0;return i&&j||Math.abs(g-e)<.01?null:i?(c=a[0][0],d=g*c+h,[c,d]):j?(c=b[0][0],d=e*c+f,[c,d]):(c=(h-f)/(e-g),d=e*c+f,[c,d])}function t(a){var b,c=a.segment[0],d=a.segment[1],e=p(a),f=e[1],g=e[0];if(b=k(a,a.outgoing),b&&a.outgoing.length>1){var h=p(b),i=s(e,h);i&&(f=i)}if(b=l(a,a.incoming),b&&a.incoming.length>1){var j=p(b),m=s(e,j);m&&(g=m)}{var n=a.ids.split("|");n[0],n[1]}return I([c,d,f,g,c])}d3.select(".interaction-all .loading").remove();var u={top:20,right:70,bottom:60,left:50},v={top:20,right:20,bottom:25,left:20},w=300,x=300,y=x-v.left-v.right,z=w-v.top-v.bottom,A=600,B=350,C=B-u.top-u.bottom,D=A-u.left-u.right,E={},F={},G={},H={},I=d3.svg.line().x(function(a){return a[0]}).y(function(a){return a[1]}).defined(function(a){return!!a}).interpolate("linear");a.sort(function(a,b){return d3.ascending(a.msOfDay,b.msOfDay)}),b.links.forEach(function(a){a.source=b.nodes[a.source],a.target=b.nodes[a.target],a.source.links=a.source.links||[],a.target.links=a.target.links||[],a.target.links.splice(0,0,a),a.source.links.splice(0,0,a),E[a.source.id+"|"+a.target.id]=a.line,E[a.target.id+"|"+a.source.id]=a.line}),b.nodes.forEach(function(a){a.x=c[a.id][0],a.y=c[a.id][1],F[a.id]=a});var J=d3.extent(b.nodes,function(a){return a.x}),K=d3.extent(b.nodes,function(a){return a.y}),L=d3.select(".interaction-all .left .glyph").append("svg").attr("class","breathing-glyph dimmable").attr("width",x).attr("height",w).append("g").attr("transform","translate("+v.left+","+v.top+")"),M=L.append("text").attr("x",y/2).attr("y",z+20).attr("text-anchor","middle"),N=d3.select(".interaction-all .right").append("svg").attr("class","horizons").attr("width",A).attr("height",B).append("g").attr("transform","translate(0,"+u.top+")"),O=d3.range(0,7),P=d3.scale.ordinal().domain([1,2,3,4,5,6,0]).rangeRoundBands([0,C],.3),Q=N.selectAll(".row").data(O).enter().append("g").attr("class","row"),R=Q.append("g").attr("transform",function(a){return"translate("+u.left+","+P(a)+")"}),S=Q.append("g").attr("class",function(a){return"dimmable day-"+a}).attr("transform",function(a){return"translate("+u.left/2+","+P(a)+")"});S.append("text").attr("class","daylabel").attr("dy",P.rangeBand()-15).attr("text-anchor","middle").text(function(a){return moment.weekdaysShort()[a]}),S.append("text").attr("class","dayofmonthlabel").attr("dy",P.rangeBand()-2).attr("text-anchor","middle").text(function(a){return"Feb "+(2+(0===a?7:a))});var T="ins_total",U=7,V={top:0,right:0,bottom:U,left:0},W=D-V.left-V.right,X=P.rangeBand()-V.top-V.bottom,Y=d3.time.scale().domain([0,864e5]).range([0,W]).clamp(!0),Z=d3.svg.axis().scale(Y).tickFormat(d3.time.format.utc("%-I%p")).orient("top").ticks(d3.time.hours,2),$=(N.append("g").attr("class","x axis").attr("transform","translate("+u.left+",0)").call(Z),d3.horizon().width(W).height(X).yMax(1.1).bands(3).mode("offset").interpolate("basis"));$.color.domain([-4,0,4]).range(["#555","white","#555"]);var ab=R.append("g").attr("class","horizon-row").attr("transform","translate("+V.left+","+V.top+")");ab.selectAll(".horizon").data(function(b){var c=d3.min(a,function(a){return a[T]}),d=d3.max(a,function(a){return a[T]}),e=d3.scale.linear().domain([c,d]),f=[_.chain(a).where({day:b}).filter(function(a){return"number"==typeof a[T]}).map(function(a){return[a.msOfDay,e(a[T])]}).value()];return f[0].day=b,f}).enter().append("g").attr("class",function(a){return"horizon dimmable day-"+a.day}).call($);var bb=_.toArray(_.groupBy(a,"day")),cb=N.append("svg:defs").selectAll("linearGradient").data(bb).enter().append("svg:linearGradient").attr("id",function(a,b){return"gradient"+b
}).attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("spreadMethod","pad"),db=d3.scale.linear().interpolate(d3.interpolateLab).domain([-.2,0,.4]).range(["rgb(0, 104, 55)","rgb(255, 255, 255)","rgb(165, 0, 38)"]),eb=d3.scale.linear().domain([0,86400]).range(["0%","100%"]);cb.selectAll("stop").data(function(a){return a}).enter().append("svg:stop").attr("offset",function(a){return eb(a.msOfDay+450)}).attr("stop-color",function(a){return db(a.delay_actual)}).attr("stop-opacity",1),ab.append("rect").attr("class",function(a){return"delay-rect dimmable day-"+a}).attr("y",X).attr("width",W).attr("height",U).attr("fill",function(a){return"url(#gradient"+a+")"});var fb=y/(J[1]-J[0]),gb=z/(K[1]-K[0]),hb=Math.min(fb,gb),ib=d3.scale.linear().domain([0,100]).range([.15*hb,.7*hb]),jb=d3.scale.linear().interpolate(d3.interpolateLab).domain([2,1,.3]).range(["rgb(0, 104, 55)","rgb(255, 255, 255)","rgb(165, 0, 38)"]),kb=.3*hb;b.nodes.forEach(function(a){a.pos=[a.x*hb,a.y*hb]});var lb=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){return a.name});L.call(lb),d3.select(".interaction-all .viz").on("mousemove",f),d3.selectAll(".interaction-all a.highlight").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=d3.select(this).attr("data-highlight");d3.selectAll(".interaction-all .viz").selectAll(a).classed("active",!0),d3.selectAll(".interaction-all .viz").classed("highlighting",!0)}).on("mouseout",function(){d3.selectAll(".interaction-all .viz .active").classed("active",!1),d3.selectAll(".interaction-all .viz").classed("highlighting",!1)}),d3.selectAll(".interaction-all a.set-time").on("click",function(){d3.event.preventDefault()}).on("mouseover",function(){var a=+d3.select(this).attr("data-day"),b=d3.select(this).attr("data-time"),c=moment(b+" -0400","hh:mm a Z").diff(moment(b+" -0400","hh:mm a Z").startOf("day"));g(a,c)});var mb=N.append("g").attr("class","indicator dimmable").attr("transform","translate(-100,0)");mb.append("line").attr("x1",0).attr("x2",0).attr("y1",-10).attr("y2",P.rangeBand()+10);var nb=mb.append("text").attr("dx",-3).attr("dy",-1).attr("text-anchor","end"),ob=mb.append("text").attr("dx",3).attr("dy",-1).attr("text-anchor","beginning"),pb=mb.append("text").attr("dx",3).attr("dy",P.rangeBand()+10).attr("text-anchor","beginning"),qb=d3.bisector(function(a){return a.msOfDay}).left,rb=9e5;!function(){{var a=150,b=N.append("g").attr("class","dimmable delay-rect key");b.append("text").attr("text-anchor","middle").attr("y",6).text("Color shows delay")}b.attr("transform","translate("+(.15*D+u.left)+","+(C+20)+")");var c=d3.scale.linear().domain(d3.extent(db.domain())).range([0,a]);VIZ.createColorScaleGradient(db,"delayGradient");var d=b.append("g"),e=(d.append("rect").attr("x",-a/2).attr("y",10).attr("width",a).attr("height",6).attr("fill","url(#delayGradient)"),d3.svg.axis().scale(c).orient("bottom").tickFormat(function(a){var b=d3.format(".0%")(a),c=d3.format(".0%")(-a);return 0>a?c+" faster":a>0?b+" slower":"on time"}).tickValues([d3.min(db.domain()),0,d3.max(db.domain())]).tickSize(4));d.append("g").attr("class","x axis").attr("transform",function(){return"translate("+-a/2+",16)"}).call(e).append("text").attr("text-anchor","beginning").attr("x",a+30).attr("dy",15).text("than normal")}(),function(){var a={top:5,right:v.right,bottom:10,left:v.left},b=300-a.left-a.right,c=d3.selectAll(".interaction-all .left .key").append("svg").attr("width",300).attr("height",60).append("g").attr("transform","translate("+a.left+","+a.top+")"),d=c.append("text").attr("x",b/2).attr("y",10).attr("text-anchor","middle");d.text("Line width shows turnstile entries at a station");var e=[0,50,100],f=d3.scale.ordinal().domain(e).range([33,77,130]),g=c.selectAll(".path").data(e).enter().append("g").attr("class","path connect").attr("transform",function(a){return"translate("+(f(a)-ib(a)-4)+",28)"});g.append("path").datum(function(a){return[[-ib(a),0],[.75*-ib(a),10],[.75*ib(a),10],[ib(a),0],[.75*ib(a),-10],[.75*-ib(a),-10],[-ib(a),0]]}).style("stroke","none").style("fill",db(-.01)).attr("d",I),g.append("path").datum(function(a){return[[-ib(a),0],[.75*-ib(a),10],null,[.75*ib(a),10],[ib(a),0],[.75*ib(a),-10],null,[.75*-ib(a),-10],[-ib(a),0],null,[-ib(a),0],[ib(a),0],null,[0,10],[0,-10]]}).style("stroke","black").style("fill","none").attr("d",I),c.selectAll("text.num").data(e).enter().append("text").attr("class","num").text(d3.format(",.0f")).attr("x",function(a){return f(a)}).attr("y",32),c.append("text").attr("text-anchor","beginning").attr("x",f(_.last(e))+20).attr("y",32).text("people per minute")}(),function(){{var b=150,c=N.append("g").attr("class","dimmable horizon key");c.append("text").attr("text-anchor","middle").attr("y",6).text("Gray bars show entries to all stations")}c.attr("transform","translate("+(3*D/4+u.left)+","+(C+20)+")");var d=c.append("g"),e=d3.max(a,function(a){return a.ins_total}),f=d3.scale.linear().domain([0,1].map(function(a){return a*e})).range([0,b]),g=d3.horizon().width(b).height(6).yMax(1.1*e).bands(3).mode("offset").interpolate("basis");g.color.domain([-4,0,4]).range(["#555","white","#555"]);var h=(d.append("g").attr("class","horizon-row").attr("transform","translate("+-b/2+",10)").selectAll(".horizon").data([[[0,0],[1,e]]]).enter().append("g").attr("class",function(a){return"horizon dimmable day-"+a.day}).call(g),d3.svg.axis().scale(f).orient("bottom").tickFormat(function(a){return d3.format(".0f")(d3.round(a,-1))}).tickValues([0,1.1*e/3,1.1*e*2/3,e]).tickSize(4));d.append("g").attr("class","x axis").attr("transform",function(){return"translate("+-b/2+",16)"}).call(h).append("text").attr("text-anchor","beginning").attr("x",b+16).attr("dy",14).text("people per minute")}();var sb=L.selectAll(".connect").data(function(a){return b.links.map(function(b){return{link:b,day:a}})}).enter().append("g").attr("class","connect");sb.append("g").attr("class",function(a){return a.link.line+"-glyph "+a.link.source.id+"-"+a.link.target.id}).append("path").datum(function(a){return{incoming:h(a.link.source),line:a.link.line,ids:a.link.source.id+"|"+a.link.target.id,segment:[a.link.source.pos,a.link.target.pos],outgoing:i(a.link.target),name:a.link.source.name+" to "+a.link.target.name}}).attr("fill",e).attr("d",t).on("mouseover.tip",lb.show).on("mouseout.tip",lb.hide),sb.append("g").attr("class",function(a){return a.link.line+"-glyph "+a.link.target.id+"-"+a.link.source.id}).append("path").datum(function(a){return{incoming:h(a.link.target),line:a.link.line,ids:a.link.target.id+"|"+a.link.source.id,segment:[a.link.target.pos,a.link.source.pos],outgoing:i(a.link.source),name:a.link.target.name+" to "+a.link.source.name}}).attr("fill",e).attr("d",t).on("mouseover.tip",lb.show).on("mouseout.tip",lb.hide),j("place-asmnl","#E12D27"),j("place-alfcl","#E12D27"),j("place-brntn","#E12D27"),j("place-wondl","#2F5DA6"),j("place-bomnl","#2F5DA6"),j("place-forhl","#E87200"),j("place-ogmnl","#E87200");var I=d3.svg.line().x(function(a){return a[0]}).y(function(a){return a[1]}).interpolate("linear")});